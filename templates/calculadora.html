<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Criptomonedas - CriptoRentable</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --bg-color: #f4f7f9;
            --text-color: #2d3748;
            --card-bg: #fff;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.05);
            --header-color: #1a365d;
            --title-color: #3182ce;
            --subtitle-color: #2d3748;
            --subheader-color: #4a5568;
            --border-color: #e2e8f0;
            --input-border: #cbd5e1;
            --input-focus-border: #63b3ed;
            --input-focus-shadow: 0 0 0 0.1rem rgba(66, 153, 225, 0.25);
            --btn-primary-bg: #4299e1;
            --btn-primary-border: #4299e1;
            --btn-primary-hover-bg: #3182ce;
            --btn-primary-hover-border: #3182ce;
            --btn-warning-bg: #f6e05e;
            --btn-warning-border: #f6e05e;
            --btn-warning-color: #4a5568;
            --btn-warning-hover-bg: #d69e2e;
            --btn-warning-hover-border: #d69e2e;
            --btn-warning-hover-color: #2d3748;
            --btn-danger-bg: #f56565;
            --btn-danger-border: #f56565;
            --btn-danger-hover-bg: #e53e3e;
            --btn-danger-hover-border: #e53e3e;
            --table-bg: #fff;
            --table-border: #e2e8f0;
            --th-bg: #ebf4ff;
            --th-color: #2d3748;
            --th-border: #bee3f8;
            --td-border: #edf2f7;
            --tr-hover-bg: #f7fafc;
            --text-muted: #718096;
            --profit-color: #38a169;
            --loss-color: #e53e3e;
        }

        [data-theme="dark"] {
            --bg-color: #1a202c;
            --text-color: #e2e8f0;
            --card-bg: #2d3748;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.2);
            --header-color: #90cdf4;
            --title-color: #63b3ed;
            --subtitle-color: #e2e8f0;
            --subheader-color: #cbd5e0;
            --border-color: #4a5568;
            --input-border: #4a5568;
            --input-bg: #1a202c;
            --input-color: white;
            --input-focus-bg: #2d3748;
            --input-focus-border: #90cdf4;
            --input-focus-shadow: 0 0 0 0.1rem rgba(144, 205, 244, 0.25);
            --placeholder-color: rgba(255, 255, 255, 0.7);
            --btn-primary-bg: #3182ce;
            --btn-primary-border: #3182ce;
            --btn-primary-hover-bg: #2c5282;
            --btn-primary-hover-border: #2c5282;
            --table-bg: #2d3748;
            --table-border: #4a5568;
            --th-bg: #2c5282;
            --th-color: #e2e8f0;
            --th-border: #4a5568;
            --td-border: #4a5568;
            --tr-hover-bg: #3a4a63;
            --text-muted: #a0aec0;
            --profit-color: #68d391;
            --loss-color: #fc8181;
            --arbitraje-text-color: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: var(--text-color);
            background-color: var(--bg-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            padding: 2rem 1rem;
        }

        .card {
            border: none;
            box-shadow: var(--card-shadow);
            border-radius: 8px;
            background-color: var(--card-bg);
        }
        
        [data-theme="dark"] .card {
            border: 1px solid rgba(160, 174, 192, 0.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            color: white;
        }
        
        [data-theme="dark"] .card-body,
        [data-theme="dark"] .card-body * {
            color: white;
        }

        h1 {
            color: var(--title-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .calculadora-container {
            margin-top: 2rem;
        }

        .form-label {
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        
        [data-theme="dark"] .form-label {
            color: white;
        }

        .form-control, .form-select, .form-select-sm {
            height: 36px;
            font-size: 0.9rem;
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            max-width: 300px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--input-focus-border);
            box-shadow: var(--input-focus-shadow);
        }
        
        input[type="text"],
        input[type="number"] {
            height: 36px;
            font-size: 0.9rem;
            padding: 0.375rem 0.75rem;
            max-width: 300px;
        }
        
        .form-select-sm {
            padding-top: 0.375rem;
            padding-bottom: 0.375rem;
            height: 36px;
        }
        
        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select,
        [data-theme="dark"] .form-select-sm,
        [data-theme="dark"] input[type="text"],
        [data-theme="dark"] input[type="number"],
        [data-theme="dark"] textarea {
            background-color: var(--input-bg);
            color: var(--input-color);
            border-color: var(--input-border);
        }
        
        [data-theme="dark"] h1,
        [data-theme="dark"] h2,
        [data-theme="dark"] h3,
        [data-theme="dark"] h4,
        [data-theme="dark"] h5,
        [data-theme="dark"] h6,
        [data-theme="dark"] p,
        [data-theme="dark"] span,
        [data-theme="dark"] div,
        [data-theme="dark"] label {
            color: white;
        }
        
        [data-theme="dark"] .text-muted,
        [data-theme="dark"] .lead.text-muted {
            color: var(--text-muted) !important;
        }
        
        [data-theme="dark"] .form-control::placeholder,
        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder,
        [data-theme="dark"] select::placeholder {
            color: rgba(255, 255, 255, 0.7) !important;
        }
        
        [data-theme="dark"] .form-control:focus,
        [data-theme="dark"] input:focus,
        [data-theme="dark"] select:focus,
        [data-theme="dark"] textarea:focus {
            background-color: var(--input-focus-bg);
            color: var(--input-color);
            border-color: var(--input-focus-border);
            box-shadow: var(--input-focus-shadow);
        }

        .btn {
            font-weight: 500;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            transition: all 0.2s ease-in-out;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background-color: var(--btn-primary-bg);
            border-color: var(--btn-primary-border);
        }
        
        .btn-primary:hover {
            background-color: var(--btn-primary-hover-bg);
            border-color: var(--btn-primary-hover-border);
        }
        
        .btn-warning {
            background-color: var(--btn-warning-bg);
            border-color: var(--btn-warning-border);
            color: var(--btn-warning-color);
        }
        
        .btn-warning:hover {
            background-color: var(--btn-warning-hover-bg);
            border-color: var(--btn-warning-hover-border);
            color: var(--btn-warning-hover-color);
        }
        
        .btn-danger {
            background-color: var(--btn-danger-bg);
            border-color: var(--btn-danger-border);
        }
        
        .btn-danger:hover {
            background-color: var(--btn-danger-hover-bg);
            border-color: var(--btn-danger-hover-border);
        }

        .profit {
            color: var(--profit-color);
            font-weight: bold;
        }

        .loss {
            color: var(--loss-color);
            font-weight: bold;
        }
        
        .fila-destacada {
            background-color: #c3e6cb !important;
            font-weight: bold;
        }
        
        /* Estilos para el botón de cambio de tema */
        #theme-toggle-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        #theme-toggle {
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        #theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        #theme-toggle i {
            font-size: 1rem;
        }

        #theme-icon-light {
            color: #f6ad55;
        }

        #theme-icon-dark {
            color: #90cdf4;
        }
        
        #theme-text {
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .table-responsive {
            overflow-x: visible;
            max-width: 100%;
            position: relative;
        }
        
        .table-container {
            position: relative;
            z-index: 1;
        }
        

        
        .table-container:hover {
            z-index: 100;
        }
        
        .hover-enabled .table-container:hover #tabla-compuesto {
            transform: scaleX(1.3) scaleY(1.02);
            font-size: 0.85rem;
        }
        
        #tabla-compuesto {
            font-size: 0.75rem;
            width: 100%;
            table-layout: fixed;
            transition: transform 0.3s ease, font-size 0.3s ease;
            transform-origin: center center;
            background: var(--table-bg);
            border: 1px solid var(--table-border);
        }
        
        #tabla-compuesto th {
            background-color: var(--th-bg);
            color: var(--th-color);
            font-weight: 600;
            border-bottom: 2px solid var(--th-border);
        }
        
        #tabla-compuesto td {
            border-bottom: 1px solid var(--td-border);
        }
        
        #tabla-compuesto tbody tr:hover td {
            background-color: var(--tr-hover-bg);
        }
        
        [data-theme="dark"] #tabla-compuesto {
            background-color: #1a202c;
            color: white;
        }
        
        [data-theme="dark"] #tabla-compuesto th {
            background-color: #2c5282;
            color: white;
        }
        
        [data-theme="dark"] #tabla-compuesto tbody tr td {
            background-color: var(--card-bg) !important;
            color: white !important;
        }
        
        [data-theme="dark"] #tabla-compuesto tbody tr:first-child td {
            background-color: #c3e6cb !important;
            color: black !important;
        }
        
        [data-theme="dark"] #tabla-compuesto td {
            color: white;
            border-color: #4a5568;
        }
        
        [data-theme="dark"] #tabla-compuesto tbody tr:hover td {
            background-color: #3a4a63;
        }
        
        #tabla-compuesto th, #tabla-compuesto td {
            padding: 0.3rem 0.2rem;
            white-space: normal;
            word-wrap: break-word;
            max-width: 60px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-5">
            <h1 class="display-5 fw-bold text-primary">Calculadora de Criptomonedas</h1>
            <p class="lead text-muted">Herramienta profesional para conversiones y cálculos de criptomonedas</p>
            <div class="mt-3">
                <a href="/" class="btn btn-outline-secondary">Volver a la página principal</a>
            </div>
        </header>
        
        <div id="theme-toggle-container">
            <button id="theme-toggle" class="btn btn-outline-primary" aria-label="Cambiar tema">
                <i class="bi bi-sun-fill" id="theme-icon-light"></i>
                <i class="bi bi-moon-fill" id="theme-icon-dark" style="display:none;"></i>
                <span id="theme-text">Modo Oscuro</span>
            </button>
        </div>

        <main>
            <div class="card border-0 shadow-lg">
                <div class="card-body p-md-5 p-3">
                    <div class="calculadora-container">
                        <div class="card p-4">
                            <h4 class="mb-3">Calculadora de Criptomonedas</h4>
                            <div class="row g-3 align-items-center mb-4">
                                <div class="col-auto">
                                    <label class="form-label">Criptomoneda</label>
                                    <select class="form-select form-select-sm" id="calc-crypto">
                                        {% for c in cryptos %}
                                        <option value="{{c}}">{{c}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Moneda Fiat</label>
                                    <select class="form-select form-select-sm" id="calc-fiat">
                                        {% for f in fiats %}
                                        <option value="{{f}}">{{f}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Cantidad</label>
                                    <input type="number" class="form-control" id="calc-cantidad" value="100" min="0.01" step="any">
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Dirección</label>
                                    <select class="form-select form-select-sm" id="calc-direccion">
                                        <option value="crypto-to-fiat">Cripto → Fiat</option>
                                        <option value="fiat-to-crypto">Fiat → Cripto</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Plataforma</label>
                                    <select class="form-select form-select-sm" id="calc-plataforma">
                                        <option value="binance">Binance</option>
                                        <option value="localbitcoins">LocalBitcoins</option>
                                        <option value="paxful">Paxful</option>
                                        <option value="airtm">AirTM</option>
                                        <option value="reserve">Reserve</option>
                                    </select>
                                </div>
                            </div>
                            <div class="d-flex justify-content-center">
                                <button id="calc-btn" class="btn btn-primary btn-sm" type="button">Calcular</button>
                            </div>
                            <div id="calc-resultado" class="mt-4"></div>
                        </div>
                    </div>
                    
                    <!-- Calculadora de Arbitraje Compuesto -->
                    <div class="card p-4 mt-5">
                        <h4 class="mb-3">Calculadora de Arbitraje Compuesto</h4>
                        <div class="row g-3 align-items-center mb-4">
                            <div class="col-auto">
                                <label class="form-label">Precio Venta</label>
                                <input type="number" class="form-control" id="precio-venta" value="4000" min="0.01" step="any">
                            </div>
                            <div class="col-auto">
                                <label class="form-label">Precio Compra</label>
                                <input type="number" class="form-control" id="precio-compra" value="3900" min="0.01" step="any">
                            </div>
                            <div class="col-auto">
                                <label class="form-label">Capital USDT</label>
                                <input type="number" class="form-control" id="capital-usdt" value="100" min="0.01" step="any">
                            </div>
                            <div class="col-auto">
                                <label class="form-label">Comisión (%)</label>
                                <input type="number" class="form-control" id="comision" value="0.2" min="0" max="100" step="0.1">
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <button id="calcular-compuesto-btn" class="btn btn-success btn-sm" type="button">Calcular Arbitraje Compuesto</button>
                            <button id="toggle-hover-btn" class="btn btn-outline-info btn-sm" type="button">
                                <i class="bi bi-zoom-in"></i> Zoom
                            </button>
                        </div>
                        <div id="resultado-compuesto" class="mt-4">
                            <div class="table-responsive">
                                <div class="table-container">
                                    <table class="table table-striped table-bordered table-hover table-sm w-100" id="tabla-compuesto">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>#</th>
                                            <th>Precio Venta</th>
                                            <th>Precio Compra</th>
                                            <th>Brecha</th>
                                            <th>Comisión Venta</th>
                                            <th>USDT Venta</th>
                                            <th>COP Brutos</th>
                                            <th>4x1000 Fiat</th>
                                            <th>4x1000 USDT</th>
                                            <th>USDT Compra</th>
                                            <th>Comisión Compra</th>
                                            <th>Capital Final</th>
                                            <th>Profit USDT</th>
                                            <th>Profit Fiat</th>
                                            <th>%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Los resultados se mostrarán aquí -->
                                    </tbody>
                                </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    /**
     * Calculadora de Criptomonedas para CriptoRentable.net
     * Esta calculadora permite realizar conversiones entre criptomonedas y monedas fiat,
     * calcular ganancias potenciales y estimar comisiones.
     */
    
    /**
     * Calculadora de Arbitraje Compuesto
     * Calcula el resultado de realizar múltiples operaciones de arbitraje consecutivas
     */
    class ArbitrajeCompuesto {
        constructor() {
            this.inicializar();
        }
        
        inicializar() {
            this.precioVentaInput = document.getElementById('precio-venta');
            this.precioCompraInput = document.getElementById('precio-compra');
            this.capitalUsdtInput = document.getElementById('capital-usdt');
            this.comisionInput = document.getElementById('comision');
            this.calcularBtn = document.getElementById('calcular-compuesto-btn');
            this.resultadoTabla = document.getElementById('tabla-compuesto').getElementsByTagName('tbody')[0];
            
            this.calcularBtn.addEventListener('click', () => this.calcular());
        }
        
        calcular() {
            try {
                // Obtener valores de entrada del usuario
                let precioVenta = parseFloat(this.precioVentaInput.value);
                let precioCompraBase = parseFloat(this.precioCompraInput.value);
                let capitalUsdt = parseFloat(this.capitalUsdtInput.value);
                const comisionPct = parseFloat(this.comisionInput.value) / 100;
                
                // Validar entradas
                if (isNaN(precioVenta) || isNaN(precioCompraBase) || isNaN(capitalUsdt) || isNaN(comisionPct)) {
                    alert('Por favor, ingrese valores numéricos válidos');
                    return;
                }
                
                if (precioVenta <= precioCompraBase) {
                    alert('El precio de venta debe ser mayor que el precio de compra para obtener ganancias');
                    return;
                }
                
                if (precioVenta <= 0 || precioCompraBase <= 0 || capitalUsdt <= 0) {
                    alert('Los valores deben ser mayores que cero');
                    return;
                }
            
            // Limpiar tabla
            this.resultadoTabla.innerHTML = '';
            
            // Calcular hasta 10 ciclos
            let capitalInicial = capitalUsdt;
            
            // Valores iniciales
            let capitalActual = capitalUsdt;
            let comisionVentaInicial = null;
            let usdtVentaInicial = null;
            
            // No usamos valores predefinidos, todo se calculará dinámicamente
            
            for (let i = 0; i < 10; i++) {
                // Declarar variables que necesitaremos
                
                // Calcular comisión de venta y USDT venta solo para la primera iteración
                let comisionVenta, usdtVenta;
                if (i === 0) {
                    comisionVenta = capitalActual * comisionPct;
                    usdtVenta = capitalActual - comisionVenta;
                    // Guardar estos valores para usarlos en las siguientes iteraciones
                    comisionVentaInicial = comisionVenta;
                    usdtVentaInicial = usdtVenta;
                } else {
                    // Usar los valores de la primera iteración
                    comisionVenta = comisionVentaInicial;
                    usdtVenta = usdtVentaInicial;
                }
                
                // El precio de compra disminuye en 1 en cada iteración
                const precioCompra = precioCompraBase - i;
                const brecha = precioVenta - precioCompra;
                
                // Calcular valores para esta iteración
                const copBrutos = usdtVenta * precioVenta;
                const impuestoCop = copBrutos * 0.004; // 4x1000
                const copNetos = copBrutos - impuestoCop;
                const usdtCompra = copNetos / precioCompra;
                const comisionCompra = usdtCompra * comisionPct;
                const capitalFinal = usdtCompra - comisionCompra;
                // Calcular profit siempre con respecto al capital inicial
                const profitUsdt = capitalFinal - capitalInicial;
                const profitCop = profitUsdt * precioVenta;
                const profitPct = (profitUsdt / capitalInicial) * 100;
                
                // No actualizamos el capital para la siguiente iteración
                // capitalActual = capitalFinal;
                
                // Los valores ya están calculados en el bloque anterior
                
                // Crear fila en la tabla
                const row = this.resultadoTabla.insertRow();
                
                // Agregar color de fondo verde a la primera fila
                if (i === 0) {
                    row.style.backgroundColor = "#c3e6cb"; // Verde más agradable
                    row.style.fontWeight = "bold"; // Texto en negrita para destacar
                    row.style.color = "black"; // Texto en negro para la primera fila
                    row.classList.add("table-success"); // Clase de Bootstrap para estilo consistente
                } else if (document.documentElement.getAttribute('data-theme') === 'dark') {
                    // Aplicar estilo a cada celda individualmente
                    for (let j = 0; j < 15; j++) {
                        const cell = row.insertCell(j);
                        cell.style.backgroundColor = "#2d3748"; // Color de fondo de las tarjetas en modo oscuro
                        cell.style.color = "white"; // Texto en blanco para las demás filas en modo oscuro
                        
                        // Llenar el contenido de cada celda
                        if (j === 0) cell.textContent = i + 1;
                        else if (j === 1) cell.textContent = precioVenta.toFixed(2);
                        else if (j === 2) cell.textContent = precioCompra.toFixed(2);
                        else if (j === 3) cell.textContent = brecha.toFixed(2);
                        else if (j === 4) cell.textContent = comisionVenta.toFixed(2);
                        else if (j === 5) cell.textContent = usdtVenta.toFixed(2);
                        else if (j === 6) cell.textContent = copBrutos.toFixed(2);
                        else if (j === 7) cell.textContent = impuestoCop.toFixed(2);
                        else if (j === 8) cell.textContent = (impuestoCop / precioCompra).toFixed(2);
                        else if (j === 9) cell.textContent = usdtCompra.toFixed(2);
                        else if (j === 10) cell.textContent = comisionCompra.toFixed(2);
                        else if (j === 11) cell.textContent = capitalFinal.toFixed(2);
                        else if (j === 12) {
                            cell.textContent = profitUsdt.toFixed(2);
                            cell.className = profitUsdt >= 0 ? 'profit' : 'loss';
                        }
                        else if (j === 13) {
                            cell.textContent = profitCop.toFixed(2);
                            cell.className = profitCop >= 0 ? 'profit' : 'loss';
                        }
                        else if (j === 14) {
                            cell.textContent = profitPct.toFixed(2) + '%';
                            cell.className = profitPct >= 0 ? 'profit' : 'loss';
                        }
                    }
                    
                    // Salir del bucle de inserción de celdas normal
                    continue;
                }
                
                // Añadir celdas con los resultados
                row.insertCell(0).textContent = i + 1;
                row.insertCell(1).textContent = precioVenta.toFixed(2);
                row.insertCell(2).textContent = precioCompra.toFixed(2);
                row.insertCell(3).textContent = brecha.toFixed(2);
                row.insertCell(4).textContent = comisionVenta.toFixed(2);
                row.insertCell(5).textContent = usdtVenta.toFixed(2);
                // Estos valores ya se calcularon arriba, no necesitamos calcularlos de nuevo
                
                row.insertCell(6).textContent = copBrutos.toFixed(2);
                row.insertCell(7).textContent = impuestoCop.toFixed(2);
                row.insertCell(8).textContent = (impuestoCop / precioCompra).toFixed(2); // Calcular impuestoUsdt correctamente
                row.insertCell(9).textContent = usdtCompra.toFixed(2);
                row.insertCell(10).textContent = comisionCompra.toFixed(2);
                row.insertCell(11).textContent = capitalFinal.toFixed(2);
                
                // Añadir celdas con formato especial para profit
                const profitUsdtCell = row.insertCell(12);
                profitUsdtCell.textContent = profitUsdt.toFixed(2);
                profitUsdtCell.className = profitUsdt >= 0 ? 'profit' : 'loss';
                
                const profitCopCell = row.insertCell(13);
                profitCopCell.textContent = profitCop.toFixed(2);
                profitCopCell.className = profitCop >= 0 ? 'profit' : 'loss';
                
                const profitPctCell = row.insertCell(14);
                profitPctCell.textContent = profitPct.toFixed(2) + '%';
                profitPctCell.className = profitPct >= 0 ? 'profit' : 'loss';
                
                // El capital se actualiza arriba para la siguiente iteración
            }
            
            // Añadir fila de resumen
            const totalRow = this.resultadoTabla.insertRow();
            totalRow.className = 'table-dark';
            
            const totalProfitUsdt = capitalActual - capitalInicial;
            const totalProfitPct = (totalProfitUsdt / capitalInicial) * 100;
            
            totalRow.insertCell(0).textContent = 'TOTAL';
            totalRow.insertCell(1).colSpan = 10;
            totalRow.insertCell(2).textContent = capitalActual.toFixed(2);
            
            const totalUsdtCell = totalRow.insertCell(3);
            totalUsdtCell.textContent = totalProfitUsdt.toFixed(2);
            totalUsdtCell.className = totalProfitUsdt >= 0 ? 'profit' : 'loss';
            
            totalRow.insertCell(4).textContent = '-';
            
            const totalPctCell = totalRow.insertCell(5);
            totalPctCell.textContent = totalProfitPct.toFixed(2) + '%';
            totalPctCell.className = totalProfitPct >= 0 ? 'profit' : 'loss';
            } catch (error) {
                console.error('Error en el cálculo:', error);
                alert('Ocurrió un error al realizar los cálculos. Por favor, verifique los valores ingresados.');
            }
        }
    }
    class CriptoCalculadora {
        constructor() {
            this.tasas = {};
            this.comisiones = {
                'binance': 0.002, // 0.2%
                'localbitcoins': 0.01, // 1%
                'paxful': 0.02, // 2%
                'airtm': 0.03, // 3%
                'reserve': 0.015 // 1.5%
            };
            this.inicializar();
        }

        inicializar() {
            this.cargarElementos();
            this.configurarEventos();
            this.actualizarTasas();
        }

        cargarElementos() {
            // Obtener referencias a los elementos del DOM
            this.cryptoSelect = document.getElementById('calc-crypto');
            this.fiatSelect = document.getElementById('calc-fiat');
            this.cantidadInput = document.getElementById('calc-cantidad');
            this.direccionSelect = document.getElementById('calc-direccion');
            this.plataformaSelect = document.getElementById('calc-plataforma');
            this.resultadoDiv = document.getElementById('calc-resultado');
            this.calcularBtn = document.getElementById('calc-btn');
            
            // Mostrar mensaje de carga inicial
            this.resultadoDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Seleccione una criptomoneda y moneda fiat para obtener la tasa actual de Binance.
                </div>
            `;
        }

        configurarEventos() {
            // Configurar evento de clic para el botón calcular
            this.calcularBtn.addEventListener('click', () => this.actualizarTasas());
            
            // Actualizar tasas cuando cambia la criptomoneda o la moneda fiat
            this.cryptoSelect.addEventListener('change', () => this.actualizarTasas());
            this.fiatSelect.addEventListener('change', () => this.actualizarTasas());
            
            // Calcular automáticamente cuando cambia la dirección o plataforma
            this.direccionSelect.addEventListener('change', () => this.calcular());
            this.plataformaSelect.addEventListener('change', () => this.calcular());
            
            // Calcular al presionar Enter en el campo de cantidad
            this.cantidadInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.calcular();
                }
            });
        }

        actualizarTasas() {
            const crypto = this.cryptoSelect.value;
            const fiat = this.fiatSelect.value;
            
            if (!crypto || !fiat) {
                return;
            }
            
            // Mostrar mensaje de carga
            this.resultadoDiv.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2">Obteniendo tasa actual de Binance...</div>
                </div>
            `;
            
            // Obtener la tasa actual desde la API
            this.obtenerTasaBinance(crypto, fiat)
                .then(tasa => {
                    if (!this.tasas[crypto]) {
                        this.tasas[crypto] = {};
                    }
                    this.tasas[crypto][fiat] = tasa;
                    
                    // Mostrar la tasa obtenida
                    this.resultadoDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> Tasa actual obtenida: 1 ${crypto} = ${tasa.toFixed(2)} ${fiat}
                        </div>
                    `;
                    
                    // Calcular automáticamente con la nueva tasa
                    this.calcular();
                })
                .catch(error => {
                    console.error('Error al obtener tasa:', error);
                    this.resultadoDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> Error al obtener la tasa actual. ${error.message}
                        </div>
                    `;
                });
        }
        
        obtenerTasaBinance(crypto, fiat) {
            return new Promise((resolve, reject) => {
                // Usar el nuevo endpoint rápido para obtener el precio
                $.ajax({
                    url: "/api/quick_price",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ 
                        asset: crypto, 
                        fiat: fiat,
                        trade_type: "BUY"
                    }),
                    success: function(res) {
                        if (res.price) {
                            resolve(parseFloat(res.price));
                        } else {
                            reject(new Error('No se pudo obtener el precio de compra'));
                        }
                    },
                    error: function(xhr, status, error) {
                        reject(new Error('Error en la solicitud a la API'));
                    }
                });
            });
        }

        calcular() {
            const crypto = this.cryptoSelect.value;
            const fiat = this.fiatSelect.value;
            const cantidad = parseFloat(this.cantidadInput.value);
            const direccion = this.direccionSelect.value;
            const plataforma = this.plataformaSelect.value;
            
            if (isNaN(cantidad) || cantidad <= 0) {
                this.mostrarError('Por favor, ingrese una cantidad válida mayor que cero.');
                return;
            }
            
            // Siempre permitir recalcular con el botón Calcular
            if (this.calcularBtn === document.activeElement) {
                this.actualizarTasas();
                return;
            }
            
            // Verificar si tenemos la tasa para esta combinación
            if (!this.tasas[crypto] || !this.tasas[crypto][fiat]) {
                // Si no tenemos la tasa, intentar obtenerla primero
                this.actualizarTasas();
                return;
            }
            
            const tasa = this.tasas[crypto][fiat];
            const comision = this.comisiones[plataforma] || 0;
            
            let resultado, comisionMonto, montoFinal;
            
            if (direccion === 'crypto-to-fiat') {
                // Convertir de cripto a fiat
                resultado = cantidad * tasa;
                comisionMonto = resultado * comision;
                montoFinal = resultado - comisionMonto;
                
                this.mostrarResultado(
                    `<div class="card shadow border-primary mb-4" style="max-width:500px;margin:auto;">
                        <div class="card-header bg-gradient bg-primary text-white text-center h5">
                            <i class="bi bi-calculator"></i> Resultado de la Conversión
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-12 text-center">
                                    <h4>${cantidad} ${crypto} = ${resultado.toFixed(2)} ${fiat}</h4>
                                    <div class="text-muted">Tasa actual de Binance: 1 ${crypto} = ${tasa.toFixed(2)} ${fiat}</div>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-6">
                                    <div class="fw-bold">Comisión (${(comision*100).toFixed(1)}%):</div>
                                    <div class="text-danger">${comisionMonto.toFixed(2)} ${fiat}</div>
                                </div>
                                <div class="col-6 text-end">
                                    <div class="fw-bold">Monto final:</div>
                                    <div class="h4 text-success">${montoFinal.toFixed(2)} ${fiat}</div>
                                </div>
                            </div>
                        </div>
                    </div>`
                );
            } else {
                // Convertir de fiat a cripto
                resultado = cantidad / tasa;
                comisionMonto = resultado * comision;
                montoFinal = resultado - comisionMonto;
                
                this.mostrarResultado(
                    `<div class="card shadow border-primary mb-4" style="max-width:500px;margin:auto;">
                        <div class="card-header bg-gradient bg-primary text-white text-center h5">
                            <i class="bi bi-calculator"></i> Resultado de la Conversión
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-12 text-center">
                                    <h4>${cantidad} ${fiat} = ${resultado.toFixed(8)} ${crypto}</h4>
                                    <div class="text-muted">Tasa actual de Binance: 1 ${crypto} = ${tasa.toFixed(2)} ${fiat}</div>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-6">
                                    <div class="fw-bold">Comisión (${(comision*100).toFixed(1)}%):</div>
                                    <div class="text-danger">${comisionMonto.toFixed(8)} ${crypto}</div>
                                </div>
                                <div class="col-6 text-end">
                                    <div class="fw-bold">Monto final:</div>
                                    <div class="h4 text-success">${montoFinal.toFixed(8)} ${crypto}</div>
                                </div>
                            </div>
                        </div>
                    </div>`
                );
            }
        }

        mostrarResultado(html) {
            this.resultadoDiv.innerHTML = html;
        }

        mostrarError(mensaje) {
            this.resultadoDiv.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i> ${mensaje}
                </div>
            `;
        }
    }

    // Inicializar las calculadoras cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', () => {
        const calculadora = new CriptoCalculadora();
        const arbitrajeCompuesto = new ArbitrajeCompuesto();
        
        // Configurar el botón para activar/desactivar el efecto hover
        const toggleHoverBtn = document.getElementById('toggle-hover-btn');
        const tableContainer = document.querySelector('.table-container');
        let hoverEnabled = false;
        
        toggleHoverBtn.addEventListener('click', () => {
            if (hoverEnabled) {
                document.body.classList.remove('hover-enabled');
                toggleHoverBtn.innerHTML = '<i class="bi bi-zoom-in"></i> Zoom';
                toggleHoverBtn.classList.remove('btn-info');
                toggleHoverBtn.classList.add('btn-outline-info');
            } else {
                document.body.classList.add('hover-enabled');
                toggleHoverBtn.innerHTML = '<i class="bi bi-zoom-out"></i> Zoom';
                toggleHoverBtn.classList.remove('btn-outline-info');
                toggleHoverBtn.classList.add('btn-info');
            }
            hoverEnabled = !hoverEnabled;
        });
        
        // Función para manejar el cambio de tema
        function toggleTheme() {
            // Determinar el tema actual y cambiarlo
            if (document.documentElement.getAttribute('data-theme') === 'dark') {
                // Cambiar a modo claro
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
                document.getElementById('theme-icon-light').style.display = 'inline-block';
                document.getElementById('theme-icon-dark').style.display = 'none';
                document.getElementById('theme-text').textContent = 'Modo Oscuro';
            } else {
                // Cambiar a modo oscuro
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                document.getElementById('theme-icon-light').style.display = 'none';
                document.getElementById('theme-icon-dark').style.display = 'inline-block';
                document.getElementById('theme-text').textContent = 'Modo Claro';
            }
        }
        
        // Aplicar el tema guardado al cargar la página
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
            if (savedTheme === 'dark') {
                document.getElementById('theme-icon-light').style.display = 'none';
                document.getElementById('theme-icon-dark').style.display = 'inline-block';
                document.getElementById('theme-text').textContent = 'Modo Claro';
            }
        }
        
        // Configurar el botón de cambio de tema
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    });
    </script>
</body>
</html>