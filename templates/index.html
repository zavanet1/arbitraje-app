<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Arbitraje P2P Cripto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap 100%, sin estilos personalizados -->
</head>
<body>
<div class="container py-5">
    <h2 class="mb-4">Arbitraje Criptomonedas P2P</h2>
    <div class="card p-4">
        <form id="arbitrageForm" onsubmit="return false;">
            <div class="mb-3">
                <label class="form-label">Criptomoneda</label>
                <select class="form-select" name="asset" id="asset">
                    {% for c in cryptos %}
                    <option value="{{c}}">{{c}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Moneda Fiat</label>
                <select class="form-select" name="fiat" id="fiat">
                    {% for f in fiats %}
                    <option value="{{f}}">{{f}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Método de pago</label>
                <select class="form-select" name="pay_type" id="pay_type">
                    <option value="">Todos</option>
                    {% for p in payments %}
                    <option value="{{ p.id }}">{{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Importe (en moneda fiat)</label>
                <input type="number" class="form-control" name="amount" id="amount" value="100" min="10" step="any">
            </div>
            <button id="calcular-btn" class="btn btn-warning w-100" type="button">Calcular arbitraje</button>
        </form>
        <div style="margin-top: 2rem;"></div>
        <div id="resultado-arbitraje" class="mt-3"></div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Función para obtener métodos de pago
    function updatePaymentMethods() {
        const asset = $('#asset').val();
        const fiat = $('#fiat').val();
        
        console.log('Actualizando métodos de pago:', { asset, fiat });
        
        $.ajax({
            url: '/api/payment_methods',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ asset: asset, fiat: fiat }),
            success: function(res) {
                const $payType = $('#pay_type');
                // Limpiar el select
                $payType.empty();
                $payType.append('<option value="">Todos</option>');
                // Si los métodos de pago vienen como objetos {id, name}, mostrar solo el nombre
                if (res.payment_methods && res.payment_methods.length > 0) {
                    res.payment_methods.forEach(method => {
                        if (typeof method === 'object' && method.name) {
                            $payType.append(`<option value="${method.id}">${method.name}</option>`);
                        } else if (typeof method === 'string') {
                            $payType.append(`<option value="${method}">${method}</option>`);
                        }
                    });
                } else {
                    $payType.append('<option value="">No hay métodos disponibles</option>');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error al obtener métodos de pago:', error);
                const $payType = $('#pay_type');
                $payType.empty();
                $payType.append('<option value="">Error al cargar métodos</option>');
            }
        });
    }

    // Actualizar métodos de pago cuando cambia la criptomoneda o moneda fiat
    $('#asset, #fiat').on('change', function() {
        console.log('Cambio detectado:', $(this).attr('id'));
        updatePaymentMethods();
    });

    // Asegura que el botón funciona y no hay submit accidental
    $('#calcular-btn').on('click', function(e) {
        e.preventDefault();
        // Toma los valores con los IDs correctos
        const asset = $('#asset').val();
        const fiat = $('#fiat').val();
        const pay_type = $('#pay_type').val(); // ahora es el id
        const amount = $('#amount').val();
        if (!asset || !fiat || !amount) { // Elimina la validación de pay_type
            $('#resultado-arbitraje').html('<div class="alert alert-danger">Por favor, completa todos los campos antes de calcular.</div>');
            return;
        }
        $('#resultado-arbitraje').html('<div class="text-center"><div class="spinner-border text-warning" role="status"></div><div>Cargando...</div></div>');
        $.ajax({
            url: "/api/arbitrage",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ asset, fiat, pay_type: pay_type || null, amount }),
            success: function(res) {
                console.log('Resultado del arbitraje:', res);
                
                let html = `
                    <div class="card shadow border-success mb-4" style="max-width:500px;margin:auto;">
                        <div class="card-header bg-gradient bg-success text-white text-center h5">
                            <i class="bi bi-graph-up-arrow"></i> Resultado Detallado de Arbitraje
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-6">
                                    <span class="badge bg-primary"><i class="bi bi-cart-plus"></i> Compra</span>
                                    <div class="fw-bold"><span style='color:#d18c00;font-size:15px;'>${res.buy_nickname || ''}</span></div>
<div class="fw-bold">${res.buy_price} <span class="text-muted">${res.fiat}/${res.asset}</span></div>
<div class="small d-flex flex-wrap gap-1" style="word-break: break-word; white-space: normal; overflow-wrap: anywhere;">
    Métodos:
    ${Array.isArray(res.buy_methods) ? res.buy_methods.map(m => `<span class='badge bg-secondary mb-1'>${m}</span>`).join(' ') : ''}
</div>
<div class='small text-dark mt-1'>Disponible: <b>${res.buy_available || '-'}</b> ${res.asset}<br>Order Limit: <b>${res.buy_min || '-'} - ${res.buy_max || '-'}</b> ${res.fiat}</div>
                                </div>
                                <div class="col-6">
                                    <span class="badge bg-info text-dark"><i class="bi bi-cash-coin"></i> Venta</span>
                                    <div class="fw-bold"><span style='color:#d18c00;font-size:15px;'>${res.sell_nickname || ''}</span></div>
<div class="fw-bold">${res.sell_price} <span class="text-muted">${res.fiat}/${res.asset}</span></div>
<div class="small d-flex flex-wrap gap-1" style="word-break: break-word; white-space: normal; overflow-wrap: anywhere;">
    Métodos:
    ${Array.isArray(res.sell_methods) ? res.sell_methods.map(m => `<span class='badge bg-secondary mb-1'>${m}</span>`).join(' ') : ''}
</div>
<div class='small text-dark mt-1'>Disponible: <b>${res.sell_available || '-'}</b> ${res.asset}<br>Order Limit: <b>${res.sell_min || '-'} - ${res.sell_max || '-'}</b> ${res.fiat}</div>
                                </div>
                            </div>
                            <hr>
                            <div class="row text-center mb-2">
                                <div class="col-6">
                                    <i class="bi bi-currency-exchange"></i> <b>USDT comprados:</b>
                                    <div class="fs-6">${res.usdt_comprados?.toFixed(6)} <span class="text-muted">${res.asset}</span></div>
                                </div>
                                <div class="col-6">
                                    <h5>Método coincidente</h5>
                                    <div><span class="badge bg-success">${res.metodo_coincidente || 'Ninguno'}</span></div>
                                </div>
                            </div>
                            <div class="row mt-4 mb-2">
                                <div class="col-6 text-center">
                                    <div class="mb-1">Ganancia neta en USD</div>
                                    <div class="h3 text-success">${res.ganancia_usd !== null && res.ganancia_usd !== undefined ? res.ganancia_usd.toFixed(2) + ' USD' : '-'}</div>
                                </div>
                                <div class="col-6 text-center border-start">
                                    <div class="mb-1">Ganancia neta</div>
                                    <div class="h3 text-success">${res.ganancia_neta !== undefined ? res.ganancia_neta.toFixed(2) + ' ' + res.fiat : 'No se pudo calcular la ganancia'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                $('#resultado-arbitraje').html(html);

                // Mostrar precio de venta recomendado para el USUARIO (si publica anuncio)
                if (res.precio_venta_sugerido_usuario_min && res.precio_venta_sugerido_usuario_max &&
                    res.ganancia_neta_sugerida_usuario_min !== null && res.ganancia_neta_sugerida_usuario_max !== null) {
                    let recomendadoUsuario = `
                        <div class="card border-warning shadow-sm mt-4 mb-3" style="max-width:500px;margin:auto;">
                            <div class="card-header bg-warning text-dark text-center">
                                <b><i class="bi bi-megaphone"></i> Tu Precio de Venta Sugerido (si publicas anuncio)</b>
                            </div>
                            <div class="card-body text-center">
                                <p class="small mb-2">
                                    Si compras <strong>${res.asset}</strong> al precio de compra mostrado (<strong>${res.buy_price.toFixed(2)} ${res.fiat}</strong>) e inviertes <strong>${res.ves_invertidos.toFixed(2)} ${res.fiat}</strong>,
                                    y luego publicas tu propio anuncio de venta (pagando la comisión de Binance del 0.2% como vendedor):
                                </p>
                                <div class="mb-2">Para obtener una ganancia neta entre <b>2% y 5%</b> sobre tu inversión
                                 (entre <b>${res.ganancia_neta_sugerida_usuario_min.toFixed(2)} y ${res.ganancia_neta_sugerida_usuario_max.toFixed(2)} ${res.fiat}</b>),
                                 deberías publicar tu anuncio de venta a un precio entre:</div>
                                <div class="h4 text-success">
                                    ${res.precio_venta_sugerido_usuario_min.toFixed(2)} y ${res.precio_venta_sugerido_usuario_max.toFixed(2)} ${res.fiat} / ${res.asset}
                                </div>
                                <div class="small text-muted mt-2">Este rango considera que tú pagas la comisión de venta de Binance.</div>
                            </div>
                        </div>
                    `;
                    $('#resultado-arbitraje').append(recomendadoUsuario);
                }

                // Mostrar precio de compra recomendado para el USUARIO (si publica anuncio de compra)
                if (res.precio_compra_sugerido_usuario_min && res.precio_compra_sugerido_usuario_max) {
                    let recomendadoCompra = `
                        <div class="card border-primary shadow-sm mt-4 mb-3" style="max-width:500px;margin:auto;">
                            <div class="card-header bg-primary text-white text-center">
                                <b><i class="bi bi-megaphone"></i> Tu Precio de Compra Sugerido (si publicas anuncio de compra)</b>
                            </div>
                            <div class="card-body text-center">
                                <p class="small mb-2">
                                    Si publicas tu propio anuncio de compra y logras comprar <strong>${res.asset}</strong> a un precio entre <strong>${res.precio_compra_sugerido_usuario_min.toFixed(2)} y ${res.precio_compra_sugerido_usuario_max.toFixed(2)} ${res.fiat}</strong>,
                                    luego puedes vender al mejor precio de venta actual y obtener una ganancia neta entre <b>2% y 5%</b> sobre tu inversión (ya descontando comisiones).
                                </p>
                                <div class="small text-muted mt-2">Mientras más bajo logres comprar, mayor será tu ganancia neta al vender.</div>
                            </div>
                        </div>
                    `;
                    $('#resultado-arbitraje').append(recomendadoCompra);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error al calcular arbitraje:', error);
                let errorMessage = xhr.responseJSON && xhr.responseJSON.error ?
                    xhr.responseJSON.error :
                    'Error desconocido';
                $('#resultado-arbitraje').html('<div class="alert alert-danger">' + errorMessage + '</div>');
            }
        });
    });
});
</script>
</body>
</html>
