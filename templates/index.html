<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitraje P2P Cripto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: #2d3748;
            background-color: #f4f7f9; /* Fondo más suave */
        }
        .container-fluid {
            max-width: 1200px; /* Aumentar más el ancho máximo para mejor uso del espacio */
            padding: 2rem 1rem;
        }
        .card {
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); /* Sombra más sutil */
            border-radius: 8px; /* Bordes ligeramente más redondeados */
            background-color: #fff;
            width: 100%;
            max-width: 1150px;
        }
        .card-body {
            padding: 2.5rem;
            width: 100%;
            max-width: 1150px;
        }
        h1, h2, h4 {
            color: #1a365d; /* Color de encabezado */
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        h1 {
            font-size: 2.5rem; /* Tamaño de título principal */
            color: #3182ce; /* Color primario para el título */
        }
        h2 {
             font-size: 1.75rem;
             color: #2d3748;
        }
         h4 {
             font-size: 1.25rem;
             color: #4a5568;
             border-bottom: 1px solid #e2e8f0; /* Separador sutil */
             padding-bottom: 0.75rem;
             margin-bottom: 1.5rem;
        }
        .form-label {
            font-size: 0.8rem; /* Etiquetas más pequeñas */
            margin-bottom: 0.25rem;
            font-weight: 500;
            color: #4a5568;
        }
        /* Inputs y selects */
        .form-control, .form-select, .form-select-sm {
            height: 36px; /* Altura ligeramente reducida */
            font-size: 0.9rem;
            padding: 0.375rem 0.75rem; /* Ajustar padding */
            border: 1px solid #cbd5e1;
            border-radius: 4px; /* Bordes menos redondeados */
            max-width: 300px; /* Limitar ancho */
        }

        .form-control:focus, .form-select:focus {
            border-color: #63b3ed; /* Borde azul claro al enfocar */
            box-shadow: 0 0 0 0.1rem rgba(66, 153, 225, 0.25); /* Sombra de enfoque sutil */
        }

        input[type="text"],
        input[type="number"] {
            height: 36px;
            font-size: 0.9rem;
            padding: 0.375rem 0.75rem;
            max-width: 300px; /* Limitar ancho */
        }

        .form-select-sm {
            padding-top: 0.375rem;
            padding-bottom: 0.375rem;
            height: 36px;
        }

        .btn {
            font-weight: 500;
            border-radius: 4px; /* Bordes menos redondeados */
            padding: 0.5rem 1rem; /* Ajustar padding */
            transition: all 0.2s ease-in-out; /* Transición suave */
            font-size: 0.9rem;
        }
        .btn-primary {
            background-color: #4299e1;
            border-color: #4299e1;
        }
        .btn-primary:hover {
            background-color: #3182ce;
            border-color: #3182ce;
        }
         .btn-warning {
            background-color: #f6e05e;
            border-color: #f6e05e;
            color: #4a5568;
        }
        .btn-warning:hover {
            background-color: #d69e2e;
            border-color: #d69e2e;
             color: #2d3748;
        }
         .btn-danger {
            background-color: #f56565;
            border-color: #f56565;
        }
        .btn-danger:hover {
            background-color: #e53e3e;
            border-color: #e53e3e;
        }

        /* Estilos específicos para los botones de la tabla */
        #transaction-table .btn-sm {
            padding: 0.25rem 0.5rem; /* Padding más pequeño para botones de tabla */
            font-size: 0.8rem; /* Fuente más pequeña */
            min-width: auto; /* Eliminar min-width fijo */
            margin-right: 0.2rem; /* Espacio reducido entre botones */
        }

        table {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px; /* Bordes redondeados para la tabla */
            overflow: hidden; /* Asegura que los bordes redondeados se apliquen */
            width: 100%;
            border-collapse: collapse; /* Colapsar bordes */
        }
        th, td {
            vertical-align: middle;
            text-align: left; /* Alinear texto a la izquierda en celdas */
            padding: 0.75rem 1rem; /* Padding en celdas */
            border-bottom: 1px solid #edf2f7;
        }
         th {
            background-color: #ebf4ff; /* Fondo sutil para encabezados */
            color: #2d3748;
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 2px solid #bee3f8; /* Borde inferior más pronunciado */
        }
        td {
             font-size: 0.875rem;
        }
        tr:hover td {
            background-color: #f7fafc; /* Fondo suave al pasar el ratón */
        }
         /* Estilo para la columna de acciones */
        #transaction-table td:last-child {
            text-align: center; /* Centrar botones de acción */
            white-space: nowrap; /* Evitar que los botones se envuelvan */
        }

        /* Animación y transición para filas de tabla */
        #transaction-table tbody tr {
            transition: background-color 0.3s ease-in-out; /* Transición suave para el fondo */
        }
        #transaction-table tbody tr.editing {
            background: #fff5e5 !important; /* Fondo amarillo claro al editar */
        }

        /* Inputs y selects en modo edición de la tabla */
        #transaction-table select, #transaction-table input[type="text"] {
            border-radius: 4px;
            border: 1px solid #a0aec0; /* Borde más visible al editar */
            padding: 0.2rem 0.4rem;
            font-size: 0.85rem;
            width: 100%; /* Ocupar todo el ancho de la celda */
            box-sizing: border-box; /* Incluir padding y borde en el ancho */
        }

        /* Estilos para los resultados de arbitraje y búsqueda de usuario */
        .resultados-flex {
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Espacio reducido */
            align-items: stretch; /* Estirar tarjetas para igualar altura */
            justify-content: center;
            margin-top: 2rem;
        }
        @media (min-width: 768px) {
            .resultados-flex {
                flex-direction: row;
                gap: 1.5rem;
                align-items: flex-start;
            }
        }
        .resultado-card {
            flex: 1 1 300px; /* Base más pequeña */
            min-width: 280px; /* Ancho mínimo ajustado */
            max-width: none; /* Eliminar ancho máximo fijo */
            min-height: auto; /* Eliminar altura mínima fija */
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Sombra más ligera */
            padding: 1.25rem; /* Padding reducido */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Espacio entre contenido */
            margin: 0; /* Eliminar margen lateral */
        }
        .resultado-card.usuario {
            border: 1px solid #63b3ed; /* Borde azul claro */
            background: linear-gradient(135deg, #ebf8ff 80%, #fff 100%); /* Degradado sutil */
        }
        .resultado-card.global {
            border: 1px solid #68d391; /* Borde verde claro */
            background: linear-gradient(135deg, #f0fff4 80%, #fff 100%); /* Degradado sutil */
        }
        .resultado-card .header {
            font-size: 1rem; /* Tamaño de encabezado de tarjeta */
            font-weight: 700;
            margin-bottom: 0.75rem; /* Margen reducido */
            letter-spacing: 0.25px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
        .resultado-card .fw-bold {
            font-size: 1rem;
        }
        .resultado-card .badge {
            font-size: 0.85em; /* Tamaño de badge */
            padding: 0.3em 0.6em;
        }
        .resultado-card .info-row {
            margin-bottom: 0.3rem; /* Espacio reducido */
        }
         .profit {
            color: #38a169; /* Verde más suave */
            font-weight: bold;
        }
        .loss {
            color: #e53e3e; /* Rojo */
            font-weight: bold;
        }
         .text-muted {
            color: #718096 !important; /* Color gris más oscuro */
        }

        /* Responsive para formularios */
        @media (max-width: 767px) {
             .container-fluid {
                padding: 1rem;
            }
            .card-body {
                padding: 1.5rem;
            }
            .row.g-3 > .col-auto {
                width: 100%; /* Columnas ocupan todo el ancho en móviles */
                margin-top: 0.5rem; /* Espacio entre elementos */
            }
             .row.g-3 > .col-auto:first-child {
                margin-top: 0; /* Eliminar margen superior del primer elemento */
            }
            .d-flex.justify-content-center {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            .btn {
                width: 100%;
                margin-bottom: 0 !important; /* Eliminar margen inferior si se usa gap */
            }
             #transaction-table th, #transaction-table td {
                padding: 0.5rem 0.75rem; /* Reducir padding en tabla para móviles */
            }
             #transaction-table .btn-sm {
                padding: 0.15rem 0.3rem;
                font-size: 0.75rem;
            }
        }

    </style>
</head>
<body class="minimalist-theme">
    <div class="container-fluid">
        <header class="text-center mb-5">
            <h1 class="display-5 fw-bold text-primary">Arbitraje P2P</h1>
            <p class="lead text-muted">Plataforma profesional de análisis de mercados</p>
        </header>

        <main>
            <div class="card border-0 shadow-lg">
                <div class="card-body p-5">
                    <h2 class="mb-4 fs-4 text-secondary">Arbitraje Criptomonedas P2P</h2>
                    <div class="card p-4">
                        <form id="arbitrageForm" onsubmit="return false;">
                            <div class="row g-3 align-items-center mb-4">
                                <div class="col-auto">
                                    <label class="form-label">Criptomoneda</label>
                                    <select class="form-select form-select-sm" name="asset" id="asset">
                                        {% for c in cryptos %}
                                        <option value="{{c}}">{{c}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Moneda Fiat</label>
                                    <select class="form-select form-select-sm" name="fiat" id="fiat">
                                        {% for f in fiats %}
                                        <option value="{{f}}">{{f}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Método de pago</label>
                                    <select class="form-select form-select-sm" name="pay_type" id="pay_type">
                                        <option value="">Todos</option>
                                        {% for p in payments %}
                                        <option value="{{ p.id }}">{{ p.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Importe (en moneda fiat)</label>
                                <input type="number" class="form-control" name="amount" id="amount" value="100" min="10" step="any">
                            </div>
                            <div class="d-flex justify-content-center">
                                <button id="calcular-btn" class="btn btn-warning btn-sm" type="button">Calcular arbitraje</button>
                            </div>
                        </form>
                        <div style="margin-top: 2rem;"></div>
                        <div id="resultado-arbitraje" class="mt-3"></div>
                    </div>

                    <div class="card p-4 mt-5">
                        <h4 class="mb-3">Buscar anuncio de usuario específico</h4>
                        <form id="buscarUsuarioForm" onsubmit="return false;">
                            <div class="row g-3 align-items-center mb-4">
                                <div class="col-auto">
                                    <label class="form-label">Usuario (nickname exacto)</label>
                                    <input type="text" class="form-control form-control-sm" name="nickname" id="nickname" placeholder="Ej: JuanPerez123" required>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Criptomoneda</label>
                                    <select class="form-select form-select-sm" name="asset_usuario" id="asset_usuario">
                                        {% for c in cryptos %}
                                        <option value="{{c}}">{{c}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Moneda Fiat</label>
                                    <select class="form-select form-select-sm" name="fiat_usuario" id="fiat_usuario">
                                        {% for f in fiats %}
                                        <option value="{{f}}">{{f}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Tipo de anuncio</label>
                                    <select class="form-select form-select-sm" name="trade_type_usuario" id="trade_type_usuario">
                                        <option value="BUY">Compra</option>
                                        <option value="SELL">Venta</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Método de pago</label>
                                    <select class="form-select form-select-sm" name="pay_type_usuario" id="pay_type_usuario_usuario">
                                        <option value="">Todos</option>
                                        {% for p in payments %}
                                        <option value="{{ p.id }}">{{ p.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12 d-flex justify-content-center">
                                    <button id="buscar-usuario-btn" class="btn btn-primary btn-sm" type="button">Buscar anuncio</button>
                                </div>
                            </div>
                        </form>
                        <div id="resultado-usuario" class="mt-3"></div>
                    </div>

                    <div class="card p-4 mt-5">
                        <h4 class="mb-3">Formulario de Transacciones</h4>
                        <form id="transactionForm" onsubmit="return false;">
                            <div class="row g-3 align-items-center mb-4">
                                <div class="col">
                                    <label class="form-label">Seleccionar Cripto</label>
                                    <select class="form-select form-select-sm" id="crypto_trans">
                                        {% for c in cryptos %}
                                        <option value="{{c}}">{{c}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col">
                                    <label class="form-label">Seleccionar Moneda Fiat</label>
                                    <select class="form-select form-select-sm" id="fiat_trans">
                                        {% for f in fiats %}
                                        <option value="{{f}}">{{f}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col">
                                    <label class="form-label">Seleccionar Método de Pago</label>
                                    <select class="form-select form-select-sm" id="payment-method-trans">
                                        <option value="">Todos</option>
                                        {% for p in payments %}
                                        <option value="{{ p.id }}">{{ p.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row g-3 mb-4">
                                <div class="col">
                                    <label class="form-label">Monto de Compra</label>
                                    <input type="text" class="form-control" id="buy-amount" placeholder="Ingrese el monto de compra">
                                </div>
                                <div class="col">
                                    <label class="form-label">Monto de Venta</label>
                                    <input type="text" class="form-control" id="sell-amount" placeholder="Ingrese el monto de venta">
                                </div>
                                <div class="col">
                                    <label class="form-label">Comisión</label>
                                    <input type="text" class="form-control" id="commission" placeholder="Ingrese la comisión">
                                </div>
                            </div>
                            <div class="d-flex justify-content-center">
                                <button id="add-btn" class="btn btn-primary btn-sm" type="button">Agregar</button>
                                <button id="clear-btn" class="btn btn-danger btn-sm" type="button">Borrar Todo</button>
                            </div>
                        </form>

                        <table id="transaction-table" class="table mt-4">
                            <thead>
                                <tr>
                                    <th>Cripto</th>
                                    <th>Moneda Fiat</th>
                                    <th>Método de Pago</th>
                                    <th>Monto de Compra</th>
                                    <th>Monto de Venta</th>
                                    <th>Comisión</th>
                                    <th>Ganancia</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sección de resultados -->
            <div class="mt-5">
                {{ results_table|safe }}
            </div>
        </main>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    // Opciones de métodos de pago para selects independientes en la tabla
    window.paymentsOptions = `<option value="">Todos</option>{% for p in payments %}<option value="{{ p.id }}">{{ p.name }}</option>{% endfor %}`;
    $(document).ready(function() {
        // Función para obtener métodos de pago
        function updatePaymentMethods() {
            const asset = $('#asset').val();
            const fiat = $('#fiat').val();
            
            console.log('Actualizando métodos de pago:', { asset, fiat });
            
            $.ajax({
                url: '/api/payment_methods',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ asset: asset, fiat: fiat }),
                success: function(res) {
                    const $payType = $('#pay_type');
                    // Limpiar el select
                    $payType.empty();
                    $payType.append('<option value="">Todos</option>');
                    // Si los métodos de pago vienen como objetos {id, name}, mostrar solo el nombre
                    if (res.payment_methods && res.payment_methods.length > 0) {
                        res.payment_methods.forEach(method => {
                            if (typeof method === 'object' && method.name) {
                                $payType.append(`<option value="${method.id}">${method.name}</option>`);
                            } else if (typeof method === 'string') {
                                $payType.append(`<option value="${method}">${method}</option>`);
                            }
                        });
                    } else {
                        $payType.append('<option value="">No hay métodos disponibles</option>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error al obtener métodos de pago:', error);
                    const $payType = $('#pay_type');
                    $payType.empty();
                    $payType.append('<option value="">Error al cargar métodos</option>');
                }
            });
        }

        // Actualizar métodos de pago cuando cambia la criptomoneda o moneda fiat
        // Agregar delay para esperar cambios en los select
        let assetTimeout = null;
        let fiatTimeout = null;
        
        $('#asset, #fiat').on('change', function() {
            const id = $(this).attr('id');
            console.log('Cambio detectado:', id);
            
            // Limpiar timeout anterior si existe
            if (id === 'asset' && assetTimeout) {
                clearTimeout(assetTimeout);
            } else if (id === 'fiat' && fiatTimeout) {
                clearTimeout(fiatTimeout);
            }
            
            // Establecer nuevo timeout
            if (id === 'asset') {
                assetTimeout = setTimeout(updatePaymentMethods, 500);
            } else {
                fiatTimeout = setTimeout(updatePaymentMethods, 500);
            }
        });

        // Asegura que el botón funciona y no hay submit accidental
        $('#calcular-btn').on('click', function(e) {
            e.preventDefault();
            // Toma los valores con los IDs correctos
            const asset = $('#asset').val();
            const fiat = $('#fiat').val();
            const pay_type = $('#pay_type').val(); // ahora es el id
            const amount = $('#amount').val();
            if (!asset || !fiat || !amount) { // Elimina la validación de pay_type
                $('#resultado-arbitraje').html('<div class="alert alert-danger">Por favor, completa todos los campos antes de calcular.</div>');
                return;
            }
            $('#resultado-arbitraje').html('<div class="text-center"><div class="spinner-border text-warning" role="status"></div><div>Cargando...</div></div>');
            $.ajax({
                url: "/api/arbitrage",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ asset, fiat, pay_type: pay_type || null, amount }),
                success: function(res) {
                    console.log('Resultado del arbitraje:', res);
                    
                    let html = `
                        <div class="card shadow border-success mb-4" style="max-width:500px;margin:auto;">
                            <div class="card-header bg-gradient bg-success text-white text-center h5">
                                <i class="bi bi-graph-up-arrow"></i> Resultado Detallado de Arbitraje
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-6">
                                        <span class="badge bg-primary"><i class="bi bi-cart-plus"></i> Compra</span>
                                        <div class="fw-bold"><span style='color:#d18c00;font-size:15px;'>${res.buy_nickname || ''}</span></div>
<div class="fw-bold">${res.buy_price} <span class="text-muted">${res.fiat}/${res.asset}</span></div>
<div class="small d-flex flex-wrap gap-1" style="word-break: break-word; white-space: normal; overflow-wrap: anywhere;">
    Métodos:
    ${Array.isArray(res.buy_methods) ? res.buy_methods.map(m => `<span class='badge bg-secondary mb-1'>${m}</span>`).join(' ') : ''}
</div>
<div class='small text-dark mt-1'>Disponible: <b>${res.buy_available || '-'}</b> ${res.asset}<br>Order Limit: <b>${res.buy_min || '-'} - ${res.buy_max || '-'}</b> ${res.fiat}</div>
                                    </div>
                                    <div class="col-6">
                                        <span class="badge bg-info text-dark"><i class="bi bi-cash-coin"></i> Venta</span>
                                        <div class="fw-bold"><span style='color:#d18c00;font-size:15px;'>${res.sell_nickname || ''}</span></div>
<div class="fw-bold">${res.sell_price} <span class="text-muted">${res.fiat}/${res.asset}</span></div>
<div class="small d-flex flex-wrap gap-1" style="word-break: break-word; white-space: normal; overflow-wrap: anywhere;">
    Métodos:
    ${Array.isArray(res.sell_methods) ? res.sell_methods.map(m => `<span class='badge bg-secondary mb-1'>${m}</span>`).join(' ') : ''}
</div>
<div class='small text-dark mt-1'>Disponible: <b>${res.sell_available || '-'}</b> ${res.asset}<br>Order Limit: <b>${res.sell_min || '-'} - ${res.sell_max || '-'}</b> ${res.fiat}</div>
                                    </div>
                                </div>
                                <hr>
                                <div class="row text-center mb-2">
                                    <div class="col-6">
                                        <i class="bi bi-currency-exchange"></i> <b>USDT comprados:</b>
                                        <div class="fs-6">${res.usdt_comprados?.toFixed(6)} <span class="text-muted">${res.asset}</span></div>
                                    </div>
                                    <div class="col-6">
                                        <h5>Método coincidente</h5>
                                        <div><span class="badge bg-success">${res.metodo_coincidente || 'Ninguno'}</span></div>
                                    </div>
                                </div>
                                <div class="row mt-4 mb-2">
                                    <div class="col-6 text-center">
                                        <div class="mb-1">Ganancia neta en USD</div>
                                        <div class="h3 text-success">${res.ganancia_usd !== null && res.ganancia_usd !== undefined ? res.ganancia_usd.toFixed(2) + ' USD' : '-'}</div>
                                    </div>
                                    <div class="col-6 text-center border-start">
                                        <div class="mb-1">Ganancia neta</div>
                                        <div class="h3 text-success">${res.ganancia_neta !== undefined ? res.ganancia_neta.toFixed(2) + ' ' + res.fiat : 'No se pudo calcular la ganancia'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    $('#resultado-arbitraje').html(html);

                    // Mostrar precio de venta recomendado para el USUARIO (si publica anuncio)
                    if (res.precio_venta_sugerido_usuario_min && res.precio_venta_sugerido_usuario_max &&
                        res.ganancia_neta_sugerida_usuario_min !== null && res.ganancia_neta_sugerida_usuario_max !== null) {
                        let recomendadoUsuario = `
                            <div class="card border-warning shadow-sm mt-4 mb-3" style="max-width:500px;margin:auto;">
                                <div class="card-header bg-warning text-dark text-center">
                                    <b><i class="bi bi-megaphone"></i> Tu Precio de Venta Sugerido (si publicas anuncio de venta)</b>
                                </div>
                                <div class="card-body text-center">
                                    <p class="small mb-2">
                                        Si compras <strong>${res.asset}</strong> al precio de compra mostrado (<strong>${res.buy_price.toFixed(2)} ${res.fiat}</strong>) e inviertes <strong>${res.ves_invertidos.toFixed(2)} ${res.fiat}</strong>,
                                        y luego publicas tu propio anuncio de venta (pagando la comisión de Binance del 0.2% como vendedor):
                                    </p>
                                    <div class="mb-2">Para obtener una ganancia neta entre <b>2% y 5%</b> sobre tu inversión
                                     (entre <b>${res.ganancia_neta_sugerida_usuario_min.toFixed(2)} y ${res.ganancia_neta_sugerida_usuario_max.toFixed(2)} ${res.fiat}</b>),
                                     deberías publicar tu anuncio de venta a un precio entre:</div>
                                    <div class="h4 text-success">
                                        ${res.precio_venta_sugerido_usuario_min.toFixed(2)} y ${res.precio_venta_sugerido_usuario_max.toFixed(2)} ${res.fiat} / ${res.asset}
                                    </div>
                                    <div class="small text-muted mt-2">Este rango considera que tú pagas la comisión de venta de Binance.</div>
                                </div>
                            </div>
                        `;
                        $('#resultado-arbitraje').append(recomendadoUsuario);
                    }

                    // Mostrar precio de compra recomendado para el USUARIO (si publica anuncio de compra)
                    if (res.precio_compra_sugerido_usuario_min && res.precio_compra_sugerido_usuario_max) {
                        let recomendadoCompra = `
                            <div class="card border-primary shadow-sm mt-4 mb-3" style="max-width:500px;margin:auto;">
                                <div class="card-header bg-primary text-white text-center">
                                    <b><i class="bi bi-megaphone"></i> Tu Precio de Compra Sugerido (si publicas anuncio de compra)</b>
                                </div>
                                <div class="card-body text-center">
                                    <p class="small mb-2">
                                        Si publicas tu propio anuncio de compra y logras comprar <strong>${res.asset}</strong> a un precio entre <strong>${res.precio_compra_sugerido_usuario_min.toFixed(2)} y ${res.precio_compra_sugerido_usuario_max.toFixed(2)} ${res.fiat}</strong>,
                                        luego puedes vender al mejor precio de venta actual y obtener una ganancia neta entre <b>2% y 5%</b> sobre tu inversión (ya descontando comisiones).
                                    </p>
                                    <div class="small text-muted mt-2">Mientras más bajo logres comprar, mayor será tu ganancia neta al vender.</div>
                                </div>
                            </div>
                        `;
                        $('#resultado-arbitraje').append(recomendadoCompra);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error al calcular arbitraje:', error);
                    let errorMessage = xhr.responseJSON && xhr.responseJSON.error ?
                        xhr.responseJSON.error :
                        'Error desconocido';
                    $('#resultado-arbitraje').html('<div class="alert alert-danger">' + errorMessage + '</div>');
                }
            });
        });

        // Buscar anuncios de usuario específico
        $('#buscar-usuario-btn').on('click', function(e) {
            buscarUsuario();
        });

        let intervalId = null;

        function buscarUsuario() {
            const nickname = $('#nickname').val();
            const asset = $('#asset_usuario').val();
            const fiat = $('#fiat_usuario').val();
            const trade_type = $('#trade_type_usuario').val();
            const pay_type = $('#pay_type_usuario_usuario').val();
            
            if (!nickname || !asset || !fiat || !trade_type) {
                $('#resultado-usuario').html('<div class="alert alert-danger">Por favor, completa todos los campos requeridos.</div>');
                return;
            }
            
            $('#resultado-usuario').html('<div class="text-center"><div class="spinner-border text-primary" role="status"></div><div>Buscando...</div></div>');
            
            $.ajax({
                url: "/api/buscar_usuario",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ nickname, asset, fiat, trade_type, pay_type: pay_type || null }),
                success: function(res) {
                    let html = '';
                    // Primero mostrar los anuncios del usuario buscado
                    if (res.anuncios && res.anuncios.length > 0) {
                        html += `<div class='resultados-flex align-items-stretch'>`;
                        res.anuncios.forEach(function(ad) {
                            // Calcular diferencia de precio respecto al top global
                            let diff = '';
                            if (res.anuncio_top && ad.price && res.anuncio_top.price) {
                                let diffVal = (parseFloat(ad.price) - parseFloat(res.anuncio_top.price)).toFixed(2);
                                let diffPct = ((diffVal / parseFloat(res.anuncio_top.price)) * 100).toFixed(2);
                                diff = `<div class='info-row'><b>Diferencia vs top:</b> <span class='badge bg-${diffVal > 0 ? 'danger' : 'success'}'>${diffVal} (${diffPct}%)</span></div>`;
                            }
                            html += `<div class='resultado-card global mb-4 h-100 d-flex flex-column justify-content-between'>
                                <div>
                                    <div class='header text-success'>Posición encontrada: <span class='badge bg-success'>${ad.posicion}</span></div>
                                    <div class='info-row'><b>Usuario:</b> ${ad.nickname}</div>
                                    <div class='info-row'><b>Precio:</b> <span class='text-success'>${ad.price} ${ad.fiat} / ${ad.asset}</span></div>
                                    ${diff}
                                    <div class='info-row'><b>Métodos:</b> ${(ad.methods || []).map(m=>`<span class='badge bg-secondary me-1'>${m}</span>`).join(' ')}</div>
                                    <div class='info-row'><b>Disponible:</b> ${ad.available} ${ad.asset}</div>
                                    <div class='info-row'><b>Límite:</b> ${ad.min} - ${ad.max} ${ad.fiat}</div>
                                </div>
                            </div>`;
                        });
                        // Luego el anuncio top global (ahora con color azul)
                        if (res.anuncio_top) {
                            html += `<div class='resultado-card usuario mb-4 h-100 d-flex flex-column justify-content-between'>
                                <div>
                                    <div class='header text-primary'>Anuncio en posición 1 global</div>
                                    <div class='info-row'><b>Posición:</b> <span class='badge bg-info text-dark'>1</span></div>
                                    <div class='info-row'><b>Usuario:</b> ${res.anuncio_top.nickname}</div>
                                    <div class='info-row'><b>Precio:</b> <span class='text-success'>${res.anuncio_top.price} ${res.anuncio_top.fiat} / ${res.anuncio_top.asset}</span></div>
                                    <div class='info-row'><b>Métodos:</b> ${(res.anuncio_top.methods || []).map(m=>`<span class='badge bg-secondary me-1'>${m}</span>`).join(' ')}</div>
                                    <div class='info-row'><b>Disponible:</b> ${res.anuncio_top.available} ${res.anuncio_top.asset}</div>
                                    <div class='info-row'><b>Límite:</b> ${res.anuncio_top.min} - ${res.anuncio_top.max} ${res.anuncio_top.fiat}</div>
                                </div>
                            </div>`;
                        }
                        html += `</div>`;
                    } else {
                        html += `<div class='resultado-card global mb-0 d-flex align-items-center justify-content-center text-muted' style='min-height:260px;'>No se encontraron anuncios para ese usuario.</div>`;
                        if (res.anuncio_top) {
                            html += `<div class='resultado-card usuario mb-4 mt-4'>
                                <div class='header text-primary'>Anuncio en posición 1 global</div>
                                <div class='info-row'><b>Posición:</b> <span class='badge bg-info text-dark'>1</span></div>
                                <div class='info-row'><b>Usuario:</b> ${res.anuncio_top.nickname}</div>
                                <div class='info-row'><b>Precio:</b> <span class='text-success'>${res.anuncio_top.price} ${res.anuncio_top.fiat} / ${res.anuncio_top.asset}</span></div>
                                <div class='info-row'><b>Métodos:</b> ${(res.anuncio_top.methods || []).map(m=>`<span class='badge bg-secondary me-1'>${m}</span>`).join(' ')}</div>
                                <div class='info-row'><b>Disponible:</b> ${res.anuncio_top.available} ${res.anuncio_top.asset}</div>
                                <div class='info-row'><b>Límite:</b> ${res.anuncio_top.min} - ${res.anuncio_top.max} ${res.anuncio_top.fiat}</div>
                            </div>`;
                        }
                    }
                    $('#resultado-usuario').html(html);
                },
                error: function(xhr, status, error) {
                    $('#resultado-usuario').html('<div class="alert alert-danger">Error al buscar anuncios: ' + (xhr.responseJSON?.error || error) + '</div>');
                }
            });
        }

        // Agregar botones de control de actualización automática
        $('#buscarUsuarioForm').append(`
            <div class="row mt-3">
                <div class="col-12 d-flex justify-content-center gap-2">
                    <button id="auto-refresh-btn" class="btn btn-success btn-sm" type="button">
                        <i class="bi bi-arrow-clockwise"></i> Actualización Auto (15s)
                    </button>
                    <button id="stop-refresh-btn" class="btn btn-danger btn-sm" type="button" disabled>
                        <i class="bi bi-stop-circle"></i> Detener
                    </button>
                </div>
            </div>
        `);

        // Manejar la actualización automática
        $('#auto-refresh-btn').on('click', function() {
            $(this).prop('disabled', true);
            $('#stop-refresh-btn').prop('disabled', false);
            buscarUsuario(); // Primera búsqueda inmediata
            intervalId = setInterval(buscarUsuario, 15000); // Luego cada 15 segundos
        });

        $('#stop-refresh-btn').on('click', function() {
            $(this).prop('disabled', true);
            $('#auto-refresh-btn').prop('disabled', false);
            if (intervalId !== null) {
                clearInterval(intervalId);
                intervalId = null;
            }
        });

// Función para obtener métodos de pago en el formulario de usuario
function updatePaymentMethodsUsuario() {
    const asset = $('#asset_usuario').val();
    const fiat = $('#fiat_usuario').val();
    $.ajax({
        url: '/api/payment_methods',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ asset: asset, fiat: fiat }),
        success: function(res) {
            const $payType = $('#pay_type_usuario_usuario');
            $payType.empty();
            $payType.append('<option value="">Todos</option>');
            if (res.payment_methods && res.payment_methods.length > 0) {
                res.payment_methods.forEach(method => {
                    if (typeof method === 'object' && method.name) {
                        $payType.append(`<option value="${method.id}">${method.name}</option>`);
                    } else if (typeof method === 'string') {
                        $payType.append(`<option value="${method}">${method}</option>`);
                    }
                });
            } else {
                $payType.append('<option value="">No hay métodos disponibles</option>');
            }
        },
        error: function() {
            const $payType = $('#pay_type_usuario_usuario');
            $payType.empty();
            $payType.append('<option value="">Error al cargar métodos</option>');
        }
    });
}

// Agregar delay para esperar cambios en los select del formulario de usuario
let assetUsuarioTimeout = null;
let fiatUsuarioTimeout = null;
        
$('#asset_usuario, #fiat_usuario').on('change', function() {
    const id = $(this).attr('id');
    console.log('Cambio detectado en formulario usuario:', id);
            
    // Limpiar timeout anterior si existe
    if (id === 'asset_usuario' && assetUsuarioTimeout) {
        clearTimeout(assetUsuarioTimeout);
    } else if (id === 'fiat_usuario' && fiatUsuarioTimeout) {
        clearTimeout(fiatUsuarioTimeout);
    }
            
    // Establecer nuevo timeout
    if (id === 'asset_usuario') {
        assetUsuarioTimeout = setTimeout(updatePaymentMethodsUsuario, 500);
    } else {
        fiatUsuarioTimeout = setTimeout(updatePaymentMethodsUsuario, 500);
    }
});

// Función para obtener métodos de pago en el formulario de transacciones (abajo)
function updateTransactionPaymentMethods() {
    const $crypto = $('#crypto_trans');
    const $fiat = $('#fiat_trans');
    const crypto = $crypto.val();
    const fiat = $fiat.val();
    const $paymentMethod = $('#payment-method-trans');
    console.log('[DEBUG] updateTransactionPaymentMethods - crypto:', crypto, 'fiat:', fiat);
    if (!crypto || !fiat) {
        $paymentMethod.empty();
        $paymentMethod.append('<option value="">Seleccione cripto y fiat</option>');
        $paymentMethod.prop('disabled', true);
        return;
    }
    $paymentMethod.prop('disabled', true);
    $.ajax({
        url: '/api/payment_methods',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ asset: crypto, fiat: fiat }),
        success: function(res) {
            $paymentMethod.empty();
            $paymentMethod.append('<option value="">Todos</option>');
            if (res.payment_methods && res.payment_methods.length > 0) {
                res.payment_methods.forEach(method => {
                    if (typeof method === 'object' && method.name) {
                        $paymentMethod.append(`<option value="${method.id}">${method.name}</option>`);
                    } else if (typeof method === 'string') {
                        $paymentMethod.append(`<option value="${method}">${method}</option>`);
                    }
                });
            } else {
                $paymentMethod.append('<option value="">No hay métodos disponibles</option>');
            }
            $paymentMethod.prop('disabled', false);
        },
        error: function() {
            $paymentMethod.empty();
            $paymentMethod.append('<option value="">Error al cargar métodos</option>');
            $paymentMethod.prop('disabled', false);
        }
    });
}

// Conectar eventos de cambio SOLO a los selects del formulario de transacciones
$('#crypto_trans, #fiat_trans').off('change').on('change', updateTransactionPaymentMethods);

// Al cargar la página, forzar la actualización inicial solo si ambos selects tienen valor
$(function() {
    if ($('#crypto_trans').val() && $('#fiat_trans').val()) {
        updateTransactionPaymentMethods();
    }
});

document.getElementById('add-btn').addEventListener('click', function() {
    const crypto = document.getElementById('crypto_trans').value;
    const fiat = document.getElementById('fiat_trans').value;
    const paymentMethod = document.getElementById('payment-method-trans').value;
    const buyAmount = parseFloat(document.getElementById('buy-amount').value) || 0;
    const sellAmount = parseFloat(document.getElementById('sell-amount').value) || 0;
    const commission = parseFloat(document.getElementById('commission').value) || 0;

    // Ganancia bruta
    const grossProfit = sellAmount - buyAmount;
    // Ganancia neta descontando comisión proporcional
    const netProfit = grossProfit - commission;
    // Porcentaje de comisión sobre la ganancia bruta
    let commissionPct = grossProfit !== 0 ? (commission / grossProfit) * 100 : 0;

    const table = document.getElementById('transaction-table').getElementsByTagName('tbody')[0];
    const newRow = table.insertRow();

    newRow.innerHTML = `
        <td contenteditable="false">${crypto}</td>
        <td contenteditable="false">${fiat}</td>
        <td contenteditable="false">${paymentMethod}</td>
        <td contenteditable="false">${buyAmount.toFixed(2)}</td>
        <td contenteditable="false">${sellAmount.toFixed(2)}</td>
        <td contenteditable="false">${commission.toFixed(2)}<br><span class='text-muted' style='font-size:0.8em;'>(${commissionPct.toFixed(2)}%)</span></td>
        <td contenteditable="false">${netProfit.toFixed(2)}</td>
        <td>
            <button class="edit-btn btn btn-sm btn-warning">Editar</button>
            <button class="delete-btn btn btn-sm btn-danger">Borrar</button>
        </td>
    `;

    // Generar un id único para el select de método de pago en la fila
    let rowId = Math.floor(Math.random() * 1000000);

    newRow.querySelector('.edit-btn').addEventListener('click', function() {
        const cells = newRow.querySelectorAll('td');
        const isEditable = cells[0].contentEditable === "true";
        const cryptoCell = cells[0];
        const fiatCell = cells[1];
        const paymentMethodCell = cells[2];
        const buyAmountCell = cells[3];
        const sellAmountCell = cells[4];
        const commissionCell = cells[5];
        const profitCell = cells[6];

        if (!isEditable) {
            // Guardar valores actuales
            let currentCrypto = cryptoCell.textContent.trim();
            let currentFiat = fiatCell.textContent.trim();
            let currentPayment = paymentMethodCell.textContent.trim();
            let selectId = `payment-method-trans${rowId}`;

            // Renderizar selects
            cryptoCell.innerHTML = `<select class='form-select form-select-sm' style='min-width:80px;'>${document.getElementById('crypto_trans').innerHTML}</select>`;
            fiatCell.innerHTML = `<select class='form-select form-select-sm' style='min-width:80px;'>${document.getElementById('fiat_trans').innerHTML}</select>`;
            paymentMethodCell.innerHTML = `<select id='${selectId}' class='form-select form-select-sm' style='min-width:100px;'><option>Cargando...</option></select>`;
            buyAmountCell.innerHTML = `<input type='number' class='form-control form-control-sm' value='${parseFloat(buyAmountCell.textContent).toFixed(2)}' style='width:110px;display:inline-block;' step='any'>`;
            sellAmountCell.innerHTML = `<input type='number' class='form-control form-control-sm' value='${parseFloat(sellAmountCell.textContent).toFixed(2)}' style='width:110px;display:inline-block;' step='any'>`;
            let commissionVal = commissionCell.textContent.split("(")[0].trim();
            commissionCell.innerHTML = `<input type='number' class='form-control form-control-sm' value='${parseFloat(commissionVal).toFixed(2)}' style='width:90px;display:inline-block;' step='any'>`;

            // Seleccionar valores actuales en los selects
            setTimeout(() => {
                let cryptoSelect = cryptoCell.querySelector('select');
                let fiatSelect = fiatCell.querySelector('select');
                if (cryptoSelect && currentCrypto) cryptoSelect.value = currentCrypto;
                if (fiatSelect && currentFiat) fiatSelect.value = currentFiat;
                // Función para actualizar métodos de pago según cripto y fiat
                function updateRowPaymentMethods() {
                    let asset = cryptoCell.querySelector('select').value;
                    let fiat = fiatCell.querySelector('select').value;
                    let $payType = $(paymentMethodCell).find('select');
                    $payType.empty();
                    $payType.append('<option>Cargando...</option>');
                    $.ajax({
                        url: '/api/payment_methods',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ asset: asset, fiat: fiat }),
                        success: function(res) {
                            $payType.empty();
                            $payType.append('<option value="">Todos</option>');
                            if (res.payment_methods && res.payment_methods.length > 0) {
                                res.payment_methods.forEach(method => {
                                    if (typeof method === 'object' && method.name) {
                                        $payType.append(`<option value="${method.id}">${method.name}</option>`);
                                    } else if (typeof method === 'string') {
                                        $payType.append(`<option value="${method}">${method}</option>`);
                                    }
                                });
                            } else {
                                $payType.append('<option value="">No hay métodos disponibles</option>');
                            }
                            // Seleccionar el valor actual si existe
                            if (currentPayment) {
                                $payType.find('option').each(function() {
                                    if ($(this).text() === currentPayment || $(this).val() === currentPayment) {
                                        $(this).prop('selected', true);
                                    }
                                });
                            }
                        },
                        error: function() {
                            $payType.empty();
                            $payType.append('<option value="">Error al cargar métodos</option>');
                        }
                    });
                }
                // Inicializar métodos de pago
                updateRowPaymentMethods();
                // Al cambiar cripto o fiat en la fila, actualizar métodos de pago
                $(cryptoCell).find('select').on('change', updateRowPaymentMethods);
                $(fiatCell).find('select').on('change', updateRowPaymentMethods);
            }, 10);
        } else {
            cryptoCell.textContent = cryptoCell.querySelector('select').value;
            fiatCell.textContent = fiatCell.querySelector('select').value;
            let select = paymentMethodCell.querySelector('select');
            paymentMethodCell.textContent = select ? select.options[select.selectedIndex].text : '';
            const buyAmount = parseFloat(buyAmountCell.querySelector('input').value) || 0;
            const sellAmount = parseFloat(sellAmountCell.querySelector('input').value) || 0;
            const commission = parseFloat(commissionCell.querySelector('input').value) || 0;
            buyAmountCell.textContent = buyAmount.toFixed(2);
            sellAmountCell.textContent = sellAmount.toFixed(2);
            const grossProfit = sellAmount - buyAmount;
            const netProfit = grossProfit - commission;
            let commissionPct = grossProfit !== 0 ? (commission / grossProfit) * 100 : 0;
            commissionCell.innerHTML = `${commission.toFixed(2)}<br><span class='text-muted' style='font-size:0.8em;'>(${commissionPct.toFixed(2)}%)</span>`;
            profitCell.textContent = netProfit.toFixed(2);
        }

        cells.forEach(cell => {
            if (cell !== cells[cells.length - 1]) {
                cell.contentEditable = !isEditable;
            }
        });
        this.textContent = isEditable ? 'Editar' : 'Guardar';
    });

    newRow.querySelector('.delete-btn').addEventListener('click', function() {
        table.deleteRow(newRow.rowIndex - 1);
    });
});
});
</script>
</body>
</html>
