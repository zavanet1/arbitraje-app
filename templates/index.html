<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitraje P2P Cripto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            /* Variables para modo claro (default) */
            --bg-color: #f4f7f9;
            --text-color: #2d3748;
            --card-bg: #fff;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.05);
            --header-color: #1a365d;
            --title-color: #3182ce;
            --subtitle-color: #2d3748;
            --subheader-color: #4a5568;
            --border-color: #e2e8f0;
            --input-border: #cbd5e1;
            --input-focus-border: #63b3ed;
            --input-focus-shadow: 0 0 0 0.1rem rgba(66, 153, 225, 0.25);
            --btn-primary-bg: #4299e1;
            --btn-primary-border: #4299e1;
            --btn-primary-hover-bg: #3182ce;
            --btn-primary-hover-border: #3182ce;
            --btn-warning-bg: #f6e05e;
            --btn-warning-border: #f6e05e;
            --btn-warning-color: #4a5568;
            --btn-warning-hover-bg: #d69e2e;
            --btn-warning-hover-border: #d69e2e;
            --btn-warning-hover-color: #2d3748;
            --btn-danger-bg: #f56565;
            --btn-danger-border: #f56565;
            --btn-danger-hover-bg: #e53e3e;
            --btn-danger-hover-border: #e53e3e;
            --table-bg: #fff;
            --table-border: #e2e8f0;
            --th-bg: #ebf4ff;
            --th-color: #2d3748;
            --th-border: #bee3f8;
            --td-border: #edf2f7;
            --tr-hover-bg: #f7fafc;
            --text-muted: #718096;
            --profit-color: #38a169;
            --loss-color: #e53e3e;
            --resultado-usuario-border: #63b3ed;
            --resultado-usuario-bg: linear-gradient(135deg, #ebf8ff 80%, #fff 100%);
            --resultado-global-border: #68d391;
            --resultado-global-bg: linear-gradient(135deg, #f0fff4 80%, #fff 100%);
            --nickname-color: #d18c00;
        }

        /* Modo oscuro */
        [data-theme="dark"] {
            --bg-color: #1a202c;
            --text-color: #e2e8f0;
            --card-bg: #2d3748;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.2);
            --header-color: #90cdf4;
            --title-color: #63b3ed;
            --subtitle-color: #e2e8f0;
            --subheader-color: #cbd5e0;
            --border-color: #4a5568;
            --input-border: #4a5568;
            --input-bg: #1a202c;
            --input-color: white;
            --input-focus-bg: #2d3748;
            --input-focus-border: #90cdf4;
            --input-focus-shadow: 0 0 0 0.1rem rgba(144, 205, 244, 0.25);
            --placeholder-color: rgba(255, 255, 255, 0.7);
            --nickname-color: #f6ad55;
            --arbitraje-text-color: #e2e8f0;
            --btn-primary-bg: #3182ce;
            --btn-primary-border: #3182ce;
            --btn-primary-hover-bg: #2c5282;
            --btn-primary-hover-border: #2c5282;
            --btn-warning-bg: #d69e2e;
            --btn-warning-border: #d69e2e;
            --btn-warning-color: #f7fafc;
            --btn-warning-hover-bg: #b7791f;
            --btn-warning-hover-border: #b7791f;
            --btn-warning-hover-color: #f7fafc;
            --btn-danger-bg: #e53e3e;
            --btn-danger-border: #e53e3e;
            --btn-danger-hover-bg: #c53030;
            --btn-danger-hover-border: #c53030;
            --table-bg: #2d3748;
            --table-border: #4a5568;
            --th-bg: #2c5282;
            --th-color: #e2e8f0;
            --th-border: #4a5568;
            --td-border: #4a5568;
            --tr-hover-bg: #3a4a63;
            --text-muted: #a0aec0;
            --profit-color: #68d391;
            --loss-color: #fc8181;
            --resultado-usuario-border: #4299e1;
            --resultado-usuario-bg: linear-gradient(135deg, #2c5282 60%, #1a365d 100%);
            --resultado-global-border: #48bb78;
            --resultado-global-bg: linear-gradient(135deg, #276749 60%, #1c4532 100%);
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: var(--text-color);
            background-color: var(--bg-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container-fluid {
            max-width: 1200px; /* Aumentar más el ancho máximo para mejor uso del espacio */
            padding: 2rem 1rem;
        }
        .card {
            border: none;
            box-shadow: var(--card-shadow);
            border-radius: 8px; /* Bordes ligeramente más redondeados */
            background-color: var(--card-bg);
            width: 100%;
            max-width: 1150px;
        }
        
        [data-theme="dark"] .card {
            border: 1px solid rgba(160, 174, 192, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .card-body {
            padding: 2.5rem;
            width: 100%;
            max-width: 1150px;
        }
        h1, h2, h4 {
            color: var(--header-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        h1 {
            font-size: 2.5rem; /* Tamaño de título principal */
            color: var(--title-color);
        }
        h2 {
             font-size: 1.75rem;
             color: var(--subtitle-color);
        }
         h4 {
             font-size: 1.25rem;
             color: var(--subheader-color);
             border-bottom: 1px solid var(--border-color);
             padding-bottom: 0.75rem;
             margin-bottom: 1.5rem;
        }
        .form-label {
            font-size: 0.8rem; /* Etiquetas más pequeñas */
            margin-bottom: 0.25rem;
            font-weight: 500;
            color: var(--subheader-color);
        }
        /* Inputs y selects */
        .form-control, .form-select, .form-select-sm {
            height: 36px; /* Altura ligeramente reducida */
            font-size: 0.9rem;
            padding: 0.375rem 0.75rem; /* Ajustar padding */
            border: 1px solid var(--input-border);
            border-radius: 4px; /* Bordes menos redondeados */
            max-width: 300px; /* Limitar ancho */
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select,
        [data-theme="dark"] .form-select-sm,
        [data-theme="dark"] input[type="text"],
        [data-theme="dark"] input[type="number"],
        [data-theme="dark"] textarea {
            background-color: var(--input-bg);
            color: var(--input-color);
            border-color: var(--input-border);
        }
        
        [data-theme="dark"] .form-control::placeholder,
        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder,
        [data-theme="dark"] select::placeholder {
            color: rgba(255, 255, 255, 0.7) !important;
        }
        
        [data-theme="dark"] .form-control:focus,
        [data-theme="dark"] input:focus,
        [data-theme="dark"] select:focus,
        [data-theme="dark"] textarea:focus {
            background-color: var(--input-focus-bg);
            color: var(--input-color);
            border-color: var(--input-focus-border);
            box-shadow: var(--input-focus-shadow);
        }
        
        /* Estilos para los resultados de arbitraje en modo oscuro */
        [data-theme="dark"] .arbitraje-result,
        [data-theme="dark"] .sugerencia-card {
            color: var(--arbitraje-text-color);
        }
        
        [data-theme="dark"] .arbitraje-result .text-muted,
        [data-theme="dark"] .sugerencia-card .text-muted,
        [data-theme="dark"] .sugerencia-card b,
        [data-theme="dark"] .sugerencia-card strong,
        [data-theme="dark"] .small.text-muted {
            color: rgba(255, 255, 255, 0.6) !important;
        }
        
        [data-theme="dark"] .badge.bg-info,
        [data-theme="dark"] .badge.bg-success,
        [data-theme="dark"] .badge.bg-danger {
            color: #1a202c;
        }
        
        [data-theme="dark"] .card-header.bg-primary b {
            color: white !important;
        }
        
        [data-theme="dark"] .card-header.bg-warning b {
            color: #1a202c !important;
        }
        
        [data-theme="dark"] .loading-text {
            color: white !important;
        }
        
        [data-theme="dark"] .header.text-success,
        [data-theme="dark"] .header.text-primary {
            color: white !important;
        }
        
        [data-theme="dark"] .result-label,
        [data-theme="dark"] .user-info-label {
            color: white;
        }
        
        [data-theme="dark"] .arbitraje-result b,
        [data-theme="dark"] .resultado-card b,
        [data-theme="dark"] .sugerencia-card b,
        [data-theme="dark"] .sugerencia-card strong {
            color: white;
        }
        
        [data-theme="dark"] .info-row {
            color: var(--text-color);
        }
        
        [data-theme="dark"] .price-value,
        [data-theme="dark"] .amount-value,
        [data-theme="dark"] .asset-value,
        [data-theme="dark"] .price-range,
        [data-theme="dark"] .badge {
            color: white;
        }
        
        [data-theme="dark"] .text-success,
        [data-theme="dark"] .card-body .h4.text-success {
            color: #68d391 !important;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--input-focus-border);
            box-shadow: var(--input-focus-shadow);
        }

        input[type="text"],
        input[type="number"] {
            height: 36px;
            font-size: 0.9rem;
            padding: 0.375rem 0.75rem;
            max-width: 300px; /* Limitar ancho */
        }

        .form-select-sm {
            padding-top: 0.375rem;
            padding-bottom: 0.375rem;
            height: 36px;
        }

        .btn {
            font-weight: 500;
            border-radius: 4px; /* Bordes menos redondeados */
            padding: 0.5rem 1rem; /* Ajustar padding */
            transition: all 0.2s ease-in-out; /* Transición suave */
            font-size: 0.9rem;
        }
        .btn-primary {
            background-color: var(--btn-primary-bg);
            border-color: var(--btn-primary-border);
        }
        .btn-primary:hover {
            background-color: var(--btn-primary-hover-bg);
            border-color: var(--btn-primary-hover-border);
        }
         .btn-warning {
            background-color: var(--btn-warning-bg);
            border-color: var(--btn-warning-border);
            color: var(--btn-warning-color);
        }
        .btn-warning:hover {
            background-color: var(--btn-warning-hover-bg);
            border-color: var(--btn-warning-hover-border);
            color: var(--btn-warning-hover-color);
        }
         .btn-danger {
            background-color: var(--btn-danger-bg);
            border-color: var(--btn-danger-border);
        }
        .btn-danger:hover {
            background-color: var(--btn-danger-hover-bg);
            border-color: var(--btn-danger-hover-border);
        }

        /* Estilos específicos para los botones de la tabla */
        #transaction-table .btn-sm {
            padding: 0.25rem 0.5rem; /* Padding más pequeño para botones de tabla */
            font-size: 0.8rem; /* Fuente más pequeña */
            min-width: auto; /* Eliminar min-width fijo */
            margin-right: 0.2rem; /* Espacio reducido entre botones */
        }

        table {
            background: var(--table-bg);
            border: 1px solid var(--table-border);
            border-radius: 8px; /* Bordes redondeados para la tabla */
            overflow: hidden; /* Asegura que los bordes redondeados se apliquen */
            width: 100%;
            border-collapse: collapse; /* Colapsar bordes */
        }
        th, td {
            vertical-align: middle;
            text-align: left; /* Alinear texto a la izquierda en celdas */
            padding: 0.75rem 1rem; /* Padding en celdas */
            border-bottom: 1px solid var(--td-border);
        }
         th {
            background-color: var(--th-bg);
            color: var(--th-color);
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 2px solid var(--th-border);
        }
        td {
             font-size: 0.875rem;
        }
        tr:hover td {
            background-color: var(--tr-hover-bg);
        }
         /* Estilo para la columna de acciones */
        #transaction-table td:last-child {
            text-align: center; /* Centrar botones de acción */
            white-space: nowrap; /* Evitar que los botones se envuelvan */
        }

        /* Animación y transición para filas de tabla */
        #transaction-table tbody tr {
            transition: background-color 0.3s ease-in-out; /* Transición suave para el fondo */
        }
        #transaction-table tbody tr.editing {
            background: #fff5e5 !important; /* Fondo amarillo claro al editar */
        }
        
        [data-theme="dark"] #transaction-table {
            background-color: #1a202c;
            color: white;
        }
        
        [data-theme="dark"] #transaction-table th {
            background-color: #2c5282;
            color: white;
        }
        
        [data-theme="dark"] #transaction-table tbody tr,
        .dark-row,
        .dark-row td {
            background-color: #2d3748 !important;
            color: white !important;
        }
        
        .dark-row .text-muted {
            color: #a0aec0 !important;
        }
        
        [data-theme="dark"] #transaction-table td {
            color: white;
            border-color: #4a5568;
        }
        
        [data-theme="dark"] #transaction-table tbody tr:hover td {
            background-color: #3a4a63;
        }
        
        [data-theme="dark"] #transaction-table tbody tr.editing {
            background: #4a3500 !important; /* Fondo amarillo oscuro al editar en modo oscuro */
        }

        /* Inputs y selects en modo edición de la tabla */
        #transaction-table select, #transaction-table input[type="text"] {
            border-radius: 4px;
            border: 1px solid #a0aec0; /* Borde más visible al editar */
            padding: 0.2rem 0.4rem;
            font-size: 0.85rem;
            width: 100%; /* Ocupar todo el ancho de la celda */
            box-sizing: border-box; /* Incluir padding y borde en el ancho */
        }

        /* Estilos para los resultados de arbitraje y búsqueda de usuario */
        .resultados-flex {
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Espacio reducido */
            align-items: stretch; /* Estirar tarjetas para igualar altura */
            justify-content: center;
            margin-top: 2rem;
        }
        @media (min-width: 768px) {
            .resultados-flex {
                flex-direction: row;
                gap: 1.5rem;
                align-items: flex-start;
            }
        }
        .resultado-card {
            flex: 1 1 300px; /* Base más pequeña */
            min-width: 280px; /* Ancho mínimo ajustado */
            max-width: none; /* Eliminar ancho máximo fijo */
            min-height: auto; /* Eliminar altura mínima fija */
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Sombra más ligera */
            padding: 1.25rem; /* Padding reducido */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Espacio entre contenido */
            margin: 0; /* Eliminar margen lateral */
        }
        .resultado-card.usuario {
            border: 2px solid var(--resultado-usuario-border);
            background: var(--resultado-usuario-bg);
            box-shadow: 0 0 15px rgba(66, 153, 225, 0.15);
        }
        .resultado-card.global {
            border: 2px solid var(--resultado-global-border);
            background: var(--resultado-global-bg);
            box-shadow: 0 0 15px rgba(72, 187, 120, 0.15);
        }
        
        [data-theme="dark"] .resultado-card.usuario {
            border-width: 2px;
            box-shadow: 0 0 20px rgba(144, 205, 244, 0.2);
        }
        
        [data-theme="dark"] .resultado-card.global {
            border-width: 2px;
            box-shadow: 0 0 20px rgba(104, 211, 145, 0.2);
        }
        .resultado-card .header {
            font-size: 1rem; /* Tamaño de encabezado de tarjeta */
            font-weight: 700;
            margin-bottom: 0.75rem; /* Margen reducido */
            letter-spacing: 0.25px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .resultado-card .fw-bold {
            font-size: 1rem;
        }
        .resultado-card .badge {
            font-size: 0.85em; /* Tamaño de badge */
            padding: 0.3em 0.6em;
        }
        .resultado-card .info-row {
            margin-bottom: 0.3rem; /* Espacio reducido */
        }
         .profit {
            color: var(--profit-color);
            font-weight: bold;
        }
        .loss {
            color: var(--loss-color);
            font-weight: bold;
        }
         .text-muted {
            color: var(--text-muted) !important;
        }

        /* Responsive para formularios */
        /* Estilos para el botón de cambio de tema */
        #theme-toggle-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        #theme-toggle {
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        #theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        #theme-toggle i {
            font-size: 1rem;
        }

        #theme-icon-light {
            color: #f6ad55;
        }

        #theme-icon-dark {
            color: #90cdf4;
        }
        
        #theme-text {
            font-size: 0.9rem;
            font-weight: 500;
        }

        @media (max-width: 767px) {
             .container-fluid {
                padding: 1rem;
            }
            .card-body {
                padding: 1.5rem;
            }
            .row.g-3 > .col-auto {
                width: 100%; /* Columnas ocupan todo el ancho en móviles */
                margin-top: 0.5rem; /* Espacio entre elementos */
            }
             .row.g-3 > .col-auto:first-child {
                margin-top: 0; /* Eliminar margen superior del primer elemento */
            }
            .d-flex.justify-content-center {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            .btn {
                width: 100%;
                margin-bottom: 0 !important; /* Eliminar margen inferior si se usa gap */
            }
             #transaction-table th, #transaction-table td {
                padding: 0.5rem 0.75rem; /* Reducir padding en tabla para móviles */
            }
             #transaction-table .btn-sm {
                padding: 0.15rem 0.3rem;
                font-size: 0.75rem;
            }
        }

    </style>
</head>
<body class="minimalist-theme">
    <div class="container-fluid">
        <header class="text-center mb-5">
            <div id="theme-toggle-container">
                <button id="theme-toggle" class="btn btn-outline-primary" aria-label="Cambiar tema">
                    <i class="bi bi-sun-fill" id="theme-icon-light"></i>
                    <i class="bi bi-moon-fill" id="theme-icon-dark" style="display:none;"></i>
                    <span id="theme-text">Modo Oscuro</span>
                </button>
            </div>
            <h1 class="display-5 fw-bold text-primary">Arbitraje P2P</h1>
            <p class="lead text-muted">Plataforma profesional de análisis de mercados</p>
        </header>

        <main>
            <div class="card border-0 shadow-lg">
                <div class="card-body p-5">
                    <h2 class="mb-4 fs-4 text-secondary">Arbitraje Criptomonedas P2P</h2>
                    <div class="card p-4">
                        <form id="arbitrageForm" onsubmit="return false;">
                            <div class="row g-3 align-items-center mb-4">
                                <div class="col-auto">
                                    <label class="form-label">Criptomoneda</label>
                                    <select class="form-select form-select-sm" name="asset" id="asset">
                                        {% for c in cryptos %}
                                        <option value="{{c}}">{{c}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Moneda Fiat</label>
                                    <select class="form-select form-select-sm" name="fiat" id="fiat">
                                        {% for f in fiats %}
                                        <option value="{{f}}">{{f}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Método de pago</label>
                                    <select class="form-select form-select-sm" name="pay_type" id="pay_type">
                                        <option value="">Todos</option>
                                        {% for p in payments %}
                                        <option value="{{ p.id }}">{{ p.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Importe (en moneda fiat)</label>
                                <input type="number" class="form-control" name="amount" id="amount" value="100" min="10" step="any">
                            </div>
                            <div class="d-flex justify-content-center">
                                <button id="calcular-btn" class="btn btn-warning btn-sm" type="button">Calcular arbitraje</button>
                            </div>
                        </form>
                        <div style="margin-top: 2rem;"></div>
                        <div id="resultado-arbitraje" class="mt-3"></div>
                    </div>

                    <div class="card p-4 mt-5">
                        <h4 class="mb-3">Buscar anuncio de usuario específico</h4>
                        <form id="buscarUsuarioForm" onsubmit="return false;">
                            <div class="row g-3 align-items-center mb-4">
                                <div class="col-auto">
                                    <label class="form-label">Usuario (nickname exacto)</label>
                                    <input type="text" class="form-control form-control-sm" name="nickname" id="nickname" placeholder="Ej: JuanPerez123" required>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Criptomoneda</label>
                                    <select class="form-select form-select-sm" name="asset_usuario" id="asset_usuario">
                                        {% for c in cryptos %}
                                        <option value="{{c}}">{{c}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Moneda Fiat</label>
                                    <select class="form-select form-select-sm" name="fiat_usuario" id="fiat_usuario">
                                        {% for f in fiats %}
                                        <option value="{{f}}">{{f}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Tipo de anuncio</label>
                                    <select class="form-select form-select-sm" name="trade_type_usuario" id="trade_type_usuario">
                                        <option value="BUY">Compra</option>
                                        <option value="SELL">Venta</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Método de pago</label>
                                    <select class="form-select form-select-sm" name="pay_type_usuario" id="pay_type_usuario_usuario">
                                        <option value="">Todos</option>
                                        {% for p in payments %}
                                        <option value="{{ p.id }}">{{ p.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12 d-flex justify-content-center">
                                    <button id="buscar-usuario-btn" class="btn btn-primary btn-sm" type="button">Buscar anuncio</button>
                                </div>
                            </div>
                        </form>
                        <div id="resultado-usuario" class="mt-3"></div>
                    </div>

                    <div class="card p-4 mt-5">
                        <h4 class="mb-3">Formulario de Transacciones</h4>
                        <form id="transactionForm" onsubmit="return false;">
                            <div class="row g-3 align-items-center mb-4">
                                <div class="col">
                                    <label class="form-label">Seleccionar Cripto</label>
                                    <select class="form-select form-select-sm" id="crypto_trans">
                                        {% for c in cryptos %}
                                        <option value="{{c}}">{{c}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col">
                                    <label class="form-label">Seleccionar Moneda Fiat</label>
                                    <select class="form-select form-select-sm" id="fiat_trans">
                                        {% for f in fiats %}
                                        <option value="{{f}}">{{f}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col">
                                    <label class="form-label">Seleccionar Método de Pago</label>
                                    <select class="form-select form-select-sm" id="payment-method-trans">
                                        <option value="">Todos</option>
                                        {% for p in payments %}
                                        <option value="{{ p.id }}">{{ p.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row g-3 mb-4">
                                <div class="col">
                                    <label class="form-label">Monto de Compra</label>
                                    <input type="text" class="form-control" id="buy-amount" placeholder="Ingrese el monto de compra">
                                </div>
                                <div class="col">
                                    <label class="form-label">Monto de Venta</label>
                                    <input type="text" class="form-control" id="sell-amount" placeholder="Ingrese el monto de venta">
                                </div>
                                <div class="col">
                                    <label class="form-label">Comisión</label>
                                    <input type="text" class="form-control" id="commission" placeholder="Ingrese la comisión">
                                </div>
                            </div>
                            <div class="d-flex justify-content-center">
                                <button id="add-btn" class="btn btn-primary btn-sm" type="button">Agregar</button>
                            </div>
                        </form>

                        <table id="transaction-table" class="table mt-4">
                            <thead>
                                <tr>
                                    <th>Cripto</th>
                                    <th>Moneda Fiat</th>
                                    <th>Método de Pago</th>
                                    <th>Monto de Compra</th>
                                    <th>Monto de Venta</th>
                                    <th>Comisión</th>
                                    <th>Ganancia</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows will be added here dynamically -->
                            </tbody>
                        </table>
                        <div class="d-flex justify-content-center mt-3 gap-2">
                            <button id="export-excel-btn" class="btn btn-success btn-sm" type="button">
                                <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
                            </button>
                            <button id="clear-btn" class="btn btn-danger btn-sm" type="button">Borrar Todo</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de resultados -->
            <div class="mt-5">
                {{ results_table|safe }}
            </div>
        </main>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
    // Función para manejar el cambio de tema
    function toggleTheme() {
        // Determinar el tema actual y cambiarlo
        if (document.documentElement.getAttribute('data-theme') === 'dark') {
            // Cambiar a modo claro
            document.documentElement.setAttribute('data-theme', 'light');
            localStorage.setItem('theme', 'light');
            document.getElementById('theme-icon-light').style.display = 'inline-block';
            document.getElementById('theme-icon-dark').style.display = 'none';
            document.getElementById('theme-text').textContent = 'Modo Oscuro';
            
            // Quitar clase dark-row de todas las filas
            document.querySelectorAll('#transaction-table tbody tr').forEach(row => {
                row.classList.remove('dark-row');
            });
        } else {
            // Cambiar a modo oscuro
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
            document.getElementById('theme-icon-light').style.display = 'none';
            document.getElementById('theme-icon-dark').style.display = 'inline-block';
            document.getElementById('theme-text').textContent = 'Modo Claro';
            
            // Añadir clase dark-row a todas las filas
            document.querySelectorAll('#transaction-table tbody tr').forEach(row => {
                row.classList.add('dark-row');
            });
        }
    }
    
    // Aplicar el tema guardado al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
            if (savedTheme === 'dark') {
                document.getElementById('theme-icon-light').style.display = 'none';
                document.getElementById('theme-icon-dark').style.display = 'inline-block';
                document.getElementById('theme-text').textContent = 'Modo Claro';
                
                // Aplicar modo oscuro a las filas existentes
                setTimeout(function() {
                    document.querySelectorAll('#transaction-table tbody tr').forEach(row => {
                        row.classList.add('dark-row');
                    });
                }, 100);
            }
        }
        
        // Configurar el botón de cambio de tema
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    });
    </script>
    <script>
    // Opciones de métodos de pago para selects independientes en la tabla
    window.paymentsOptions = `<option value="">Todos</option>{% for p in payments %}<option value="{{ p.id }}">{{ p.name }}</option>{% endfor %}`;

    // --- FUNCIONES DINÁMICAS PARA TODOS LOS FORMULARIOS ---
    function updatePaymentMethodsGeneric(assetSelector, fiatSelector, payTypeSelector) {
        const asset = $(assetSelector).val();
        const fiat = $(fiatSelector).val();
        const $payType = $(payTypeSelector);
        $payType.empty();
        $payType.append('<option>Cargando...</option>');
        if (!asset || !fiat) {
            $payType.empty();
            $payType.append('<option value="">Seleccione cripto y fiat</option>');
            $payType.prop('disabled', true);
            return;
        }
        $payType.prop('disabled', true);
        $.ajax({
            url: '/api/payment_methods',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ asset: asset, fiat: fiat }),
            success: function(res) {
                $payType.empty();
                $payType.append('<option value="">Todos</option>');
                if (res.payment_methods && res.payment_methods.length > 0) {
                    res.payment_methods.forEach(method => {
                        if (typeof method === 'object' && method.name) {
                            $payType.append(`<option value="${method.id}">${method.name}</option>`);
                        } else if (typeof method === 'string') {
                            $payType.append(`<option value="${method}">${method}</option>`);
                        }
                    });
                } else {
                    $payType.append('<option value="">No hay métodos disponibles</option>');
                }
                $payType.prop('disabled', false);
            },
            error: function() {
                $payType.empty();
                $payType.append('<option value="">Error al cargar métodos</option>');
                $payType.prop('disabled', false);
            }
        });
    }

    // --- FORMULARIO PRINCIPAL ---
    $('#asset, #fiat').on('change', function() {
        updatePaymentMethodsGeneric('#asset', '#fiat', '#pay_type');
    });
    // Inicializar al cargar
    $(function() {
        if ($('#asset').val() && $('#fiat').val()) {
            updatePaymentMethodsGeneric('#asset', '#fiat', '#pay_type');
        }
    });

    // --- FORMULARIO USUARIO ESPECÍFICO ---
    $('#asset_usuario, #fiat_usuario').on('change', function() {
        updatePaymentMethodsGeneric('#asset_usuario', '#fiat_usuario', '#pay_type_usuario_usuario');
    });
    // Inicializar al cargar
    $(function() {
        if ($('#asset_usuario').val() && $('#fiat_usuario').val()) {
            updatePaymentMethodsGeneric('#asset_usuario', '#fiat_usuario', '#pay_type_usuario_usuario');
        }
    });

    $(document).ready(function() {
        // Función para obtener métodos de pago
        function updatePaymentMethods() {
            const asset = $('#asset').val();
            const fiat = $('#fiat').val();
            
            console.log('Actualizando métodos de pago:', { asset, fiat });
            
            $.ajax({
                url: '/api/payment_methods',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ asset: asset, fiat: fiat }),
                success: function(res) {
                    const $payType = $('#pay_type');
                    // Limpiar el select
                    $payType.empty();
                    $payType.append('<option value="">Todos</option>');
                    // Si los métodos de pago vienen como objetos {id, name}, mostrar solo el nombre
                    if (res.payment_methods && res.payment_methods.length > 0) {
                        res.payment_methods.forEach(method => {
                            if (typeof method === 'object' && method.name) {
                                $payType.append(`<option value="${method.id}">${method.name}</option>`);
                            } else if (typeof method === 'string') {
                                $payType.append(`<option value="${method}">${method}</option>`);
                            }
                        });
                    } else {
                        $payType.append('<option value="">No hay métodos disponibles</option>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error al obtener métodos de pago:', error);
                    const $payType = $('#pay_type');
                    $payType.empty();
                    $payType.append('<option value="">Error al cargar métodos</option>');
                }
            });
        }

        // Actualizar métodos de pago cuando cambia la criptomoneda o moneda fiat
        // Agregar delay para esperar cambios en los select
        let assetTimeout = null;
        let fiatTimeout = null;
        
        $('#asset, #fiat').on('change', function() {
            const id = $(this).attr('id');
            console.log('Cambio detectado:', id);
            
            // Limpiar timeout anterior si existe
            if (id === 'asset' && assetTimeout) {
                clearTimeout(assetTimeout);
            } else if (id === 'fiat' && fiatTimeout) {
                clearTimeout(fiatTimeout);
            }
            
            // Establecer nuevo timeout
            if (id === 'asset') {
                assetTimeout = setTimeout(updatePaymentMethods, 500);
            } else {
                fiatTimeout = setTimeout(updatePaymentMethods, 500);
            }
        });

        // Asegura que el botón funciona y no hay submit accidental
        $('#calcular-btn').on('click', function(e) {
            e.preventDefault();
            // Toma los valores con los IDs correctos
            const asset = $('#asset').val();
            const fiat = $('#fiat').val();
            const pay_type = $('#pay_type').val(); // ahora es el id
            const amount = $('#amount').val();
            if (!asset || !fiat || !amount) { // Elimina la validación de pay_type
                $('#resultado-arbitraje').html('<div class="alert alert-danger">Por favor, completa todos los campos antes de calcular.</div>');
                return;
            }
            $('#resultado-arbitraje').html('<div class="text-center"><div class="spinner-border text-warning" role="status"></div><div class="loading-text">Cargando...</div></div>');
            $.ajax({
                url: "/api/arbitrage",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ asset, fiat, pay_type: pay_type || null, amount }),
                success: function(res) {
                    console.log('Resultado del arbitraje:', res);
                    
                    let html = `
                        <div class="card shadow border-success mb-4" style="max-width:500px;margin:auto;">
                            <div class="card-header bg-gradient bg-success text-white text-center h5">
                                <i class="bi bi-graph-up-arrow"></i> Resultado Detallado de Arbitraje
                            </div>
                            <div class="card-body arbitraje-result">
                                <div class="row mb-2">
                                    <div class="col-6">
                                        <span class="badge bg-primary"><i class="bi bi-cart-plus"></i> Compra</span>
                                        <div class="fw-bold"><span style='color:var(--nickname-color);font-size:15px;'>${res.buy_nickname || ''}</span></div>
<div class="fw-bold">${res.buy_price} <span class="text-muted">${res.fiat}/${res.asset}</span></div>
<div class="small d-flex flex-wrap gap-1" style="word-break: break-word; white-space: normal; overflow-wrap: anywhere;">
    Métodos:
    ${Array.isArray(res.buy_methods) ? res.buy_methods.map(m => `<span class='badge bg-secondary mb-1'>${m}</span>`).join(' ') : ''}
</div>
<div class='small mt-1'>Disponible: <b>${res.buy_available || '-'}</b> ${res.asset}<br>Order Limit: <b>${res.buy_min || '-'} - ${res.buy_max || '-'}</b> ${res.fiat}</div>
                                    </div>
                                    <div class="col-6">
                                        <span class="badge bg-info"><i class="bi bi-cash-coin"></i> Venta</span>
                                        <div class="fw-bold"><span style='color:var(--nickname-color);font-size:15px;'>${res.sell_nickname || ''}</span></div>
<div class="fw-bold">${res.sell_price} <span class="text-muted">${res.fiat}/${res.asset}</span></div>
<div class="small d-flex flex-wrap gap-1" style="word-break: break-word; white-space: normal; overflow-wrap: anywhere;">
    Métodos:
    ${Array.isArray(res.sell_methods) ? res.sell_methods.map(m => `<span class='badge bg-secondary mb-1'>${m}</span>`).join(' ') : ''}
</div>
<div class='small mt-1'>Disponible: <b>${res.sell_available || '-'}</b> ${res.asset}<br>Order Limit: <b>${res.sell_min || '-'} - ${res.sell_max || '-'}</b> ${res.fiat}</div>
                                    </div>
                                </div>
                                <hr>
                                <div class="row text-center mb-2">
                                    <div class="col-6">
                                        <i class="bi bi-currency-exchange"></i> <b class="result-label">USDT comprados:</b>
                                        <div class="fs-6">${res.usdt_comprados?.toFixed(6)} <span class="text-muted">${res.asset}</span></div>
                                    </div>
                                    <div class="col-6">
                                        <h5 class="result-label">Método coincidente</h5>
                                        <div><span class="badge bg-success">${res.metodo_coincidente || 'Ninguno'}</span></div>
                                    </div>
                                </div>
                                <div class="row mt-4 mb-2">
                                    <div class="col-6 text-center">
                                        <div class="mb-1 result-label">Ganancia neta en USD</div>
                                        <div class="h3 text-success">${res.ganancia_usd !== null && res.ganancia_usd !== undefined ? res.ganancia_usd.toFixed(2) + ' USD' : '-'}</div>
                                    </div>
                                    <div class="col-6 text-center border-start">
                                        <div class="mb-1 result-label">Ganancia neta</div>
                                        <div class="h3 text-success">${res.ganancia_neta !== undefined ? res.ganancia_neta.toFixed(2) + ' ' + res.fiat : 'No se pudo calcular la ganancia'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    $('#resultado-arbitraje').html(html);

                    // Mostrar precio de venta recomendado para el USUARIO (si publica anuncio)
                    if (res.precio_venta_sugerido_usuario_min && res.precio_venta_sugerido_usuario_max &&
                        res.ganancia_neta_sugerida_usuario_min !== null && res.ganancia_neta_sugerida_usuario_max !== null) {
                        let recomendadoUsuario = `
                            <div class="card border-warning shadow-sm mt-4 mb-3" style="max-width:500px;margin:auto;">
                                <div class="card-header bg-warning text-dark text-center">
                                    <b><i class="bi bi-megaphone"></i> Tu Precio de Venta Sugerido (si publicas anuncio de venta)</b>
                                </div>
                                <div class="card-body text-center sugerencia-card">
                                    <p class="small mb-2">
                                        Si compras <strong class="asset-value">${res.asset}</strong> al precio de compra mostrado (<strong class="price-value">${res.buy_price.toFixed(2)} ${res.fiat}</strong>) e inviertes <strong class="amount-value">${res.ves_invertidos.toFixed(2)} ${res.fiat}</strong>,
                                        y luego publicas tu propio anuncio de venta (pagando la comisión de Binance del 0.2% como vendedor):
                                    </p>
                                    <div class="mb-2">Para obtener una ganancia neta entre <b>2% y 5%</b> sobre tu inversión
                                     (entre <b class="amount-value">${res.ganancia_neta_sugerida_usuario_min.toFixed(2)} y ${res.ganancia_neta_sugerida_usuario_max.toFixed(2)} ${res.fiat}</b>),
                                     deberías publicar tu anuncio de venta a un precio entre:</div>
                                    <div class="h4 text-success price-range">
                                        ${res.precio_venta_sugerido_usuario_min.toFixed(2)} y ${res.precio_venta_sugerido_usuario_max.toFixed(2)} ${res.fiat} / ${res.asset}
                                    </div>
                                    <div class="small text-muted mt-2">Este rango considera que tú pagas la comisión de venta de Binance.</div>
                                </div>
                            </div>
                        `;
                        $('#resultado-arbitraje').append(recomendadoUsuario);
                    }

                    // Mostrar precio de compra recomendado para el USUARIO (si publica anuncio de compra)
                    if (res.precio_compra_sugerido_usuario_min && res.precio_compra_sugerido_usuario_max) {
                        let recomendadoCompra = `
                            <div class="card border-primary shadow-sm mt-4 mb-3" style="max-width:500px;margin:auto;">
                                <div class="card-header bg-primary text-white text-center">
                                    <b><i class="bi bi-megaphone"></i> Tu Precio de Compra Sugerido (si publicas anuncio de compra)</b>
                                </div>
                                <div class="card-body text-center sugerencia-card">
                                    <p class="small mb-2">
                                        Si publicas tu propio anuncio de compra y logras comprar <strong class="asset-value">${res.asset}</strong> a un precio entre <strong class="price-value">${res.precio_compra_sugerido_usuario_min.toFixed(2)} y ${res.precio_compra_sugerido_usuario_max.toFixed(2)} ${res.fiat}</strong>,
                                        luego puedes vender al mejor precio de venta actual y obtener una ganancia neta entre <b>2% y 5%</b> sobre tu inversión (ya descontando comisiones).
                                    </p>
                                    <div class="small text-muted mt-2">Mientras más bajo logres comprar, mayor será tu ganancia neta al vender.</div>
                                </div>
                            </div>
                        `;
                        $('#resultado-arbitraje').append(recomendadoCompra);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error al calcular arbitraje:', error);
                    let errorMessage = xhr.responseJSON && xhr.responseJSON.error ?
                        xhr.responseJSON.error :
                        'Error desconocido';
                    $('#resultado-arbitraje').html('<div class="alert alert-danger">' + errorMessage + '</div>');
                }
            });
        });

        // Buscar anuncios de usuario específico
        $('#buscar-usuario-btn').on('click', function(e) {
            buscarUsuario();
        });

        let intervalId = null;

        function buscarUsuario() {
            const nickname = $('#nickname').val();
            const asset = $('#asset_usuario').val();
            const fiat = $('#fiat_usuario').val();
            const trade_type = $('#trade_type_usuario').val();
            const pay_type = $('#pay_type_usuario_usuario').val();
            
            if (!nickname || !asset || !fiat || !trade_type) {
                $('#resultado-usuario').html('<div class="alert alert-danger">Por favor, completa todos los campos requeridos.</div>');
                return;
            }
            
            $('#resultado-usuario').html('<div class="text-center"><div class="spinner-border text-primary" role="status"></div><div class="loading-text">Buscando...</div></div>');
            
            $.ajax({
                url: "/api/buscar_usuario",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ nickname, asset, fiat, trade_type, pay_type: pay_type || null }),
                success: function(res) {
                    let html = '';
                    // Primero mostrar los anuncios del usuario buscado
                    if (res.anuncios && res.anuncios.length > 0) {
                        html += `<div class='resultados-flex align-items-stretch'>`;
                        res.anuncios.forEach(function(ad) {
                            // Calcular diferencia de precio respecto al top global
                            let diff = '';
                            if (res.anuncio_top && ad.price && res.anuncio_top.price) {
                                let diffVal = (parseFloat(ad.price) - parseFloat(res.anuncio_top.price)).toFixed(2);
                                let diffPct = ((diffVal / parseFloat(res.anuncio_top.price)) * 100).toFixed(2);
                                diff = `<div class='info-row'><b class="user-info-label">Diferencia vs top:</b> <span class='badge bg-${diffVal > 0 ? 'danger' : 'success'}'>${diffVal} (${diffPct}%)</span></div>`;
                            }
                            html += `<div class='resultado-card global mb-4 h-100 d-flex flex-column justify-content-between'>
                                <div>
                                    <div class='header text-success'>Posición encontrada: <span class='badge bg-success'>${ad.posicion}</span></div>
                                    <div class='info-row'><b class="user-info-label">Usuario:</b> ${ad.nickname}</div>
                                    <div class='info-row'><b class="user-info-label">Precio:</b> <span class='price-value'>${ad.price} ${ad.fiat} / ${ad.asset}</span></div>
                                    ${diff}
                                    <div class='info-row'><b class="user-info-label">Métodos:</b> ${(ad.methods || []).map(m=>`<span class='badge bg-secondary me-1'>${m}</span>`).join(' ')}</div>
                                    <div class='info-row'><b class="user-info-label">Disponible:</b> <span class="amount-value">${ad.available} ${ad.asset}</span></div>
                                    <div class='info-row'><b class="user-info-label">Límite:</b> <span class="amount-value">${ad.min} - ${ad.max} ${ad.fiat}</span></div>
                                </div>
                            </div>`;
                        });
                        // Luego el anuncio top global (ahora con color azul)
                        if (res.anuncio_top) {
                            html += `<div class='resultado-card usuario mb-4 h-100 d-flex flex-column justify-content-between'>
                                <div>
                                    <div class='header text-primary'>Anuncio en posición 1 global</div>
                                    <div class='info-row'><b class="user-info-label">Posición:</b> <span class='badge bg-info'>1</span></div>
                                    <div class='info-row'><b class="user-info-label">Usuario:</b> ${res.anuncio_top.nickname}</div>
                                    <div class='info-row'><b class="user-info-label">Precio:</b> <span class='price-value'>${res.anuncio_top.price} ${res.anuncio_top.fiat} / ${res.anuncio_top.asset}</span></div>
                                    <div class='info-row'><b class="user-info-label">Métodos:</b> ${(res.anuncio_top.methods || []).map(m=>`<span class='badge bg-secondary me-1'>${m}</span>`).join(' ')}</div>
                                    <div class='info-row'><b class="user-info-label">Disponible:</b> <span class="amount-value">${res.anuncio_top.available} ${res.anuncio_top.asset}</span></div>
                                    <div class='info-row'><b class="user-info-label">Límite:</b> <span class="amount-value">${res.anuncio_top.min} - ${res.anuncio_top.max} ${res.anuncio_top.fiat}</span></div>
                                </div>
                            </div>`;
                        }
                        html += `</div>`;
                    } else {
                        html += `<div class='resultado-card global mb-0 d-flex align-items-center justify-content-center text-muted' style='min-height:260px;'>No se encontraron anuncios para ese usuario.</div>`;
                        if (res.anuncio_top) {
                            html += `<div class='resultado-card usuario mb-4 mt-4'>
                                <div class='header text-primary'>Anuncio en posición 1 global</div>
                                <div class='info-row'><b class="user-info-label">Posición:</b> <span class='badge bg-info'>1</span></div>
                                <div class='info-row'><b class="user-info-label">Usuario:</b> ${res.anuncio_top.nickname}</div>
                                <div class='info-row'><b class="user-info-label">Precio:</b> <span class='price-value'>${res.anuncio_top.price} ${res.anuncio_top.fiat} / ${res.anuncio_top.asset}</span></div>
                                <div class='info-row'><b class="user-info-label">Métodos:</b> ${(res.anuncio_top.methods || []).map(m=>`<span class='badge bg-secondary me-1'>${m}</span>`).join(' ')}</div>
                                <div class='info-row'><b class="user-info-label">Disponible:</b> <span class="amount-value">${res.anuncio_top.available} ${res.anuncio_top.asset}</span></div>
                                <div class='info-row'><b class="user-info-label">Límite:</b> <span class="amount-value">${res.anuncio_top.min} - ${res.anuncio_top.max} ${res.anuncio_top.fiat}</span></div>
                            </div>`;
                        }
                    }
                    $('#resultado-usuario').html(html);
                },
                error: function(xhr, status, error) {
                    $('#resultado-usuario').html('<div class="alert alert-danger">Error al buscar anuncios: ' + (xhr.responseJSON?.error || error) + '</div>');
                }
            });
        }

        // Agregar botones de control de actualización automática
        $('#buscarUsuarioForm').append(`
            <div class="row mt-3">
                <div class="col-12 d-flex justify-content-center gap-2">
                    <button id="auto-refresh-btn" class="btn btn-success btn-sm" type="button">
                        <i class="bi bi-arrow-clockwise"></i> Actualización Auto (15s)
                    </button>
                    <button id="stop-refresh-btn" class="btn btn-danger btn-sm" type="button" disabled>
                        <i class="bi bi-stop-circle"></i> Detener
                    </button>
                </div>
            </div>
        `);

        // Manejar la actualización automática
        $('#auto-refresh-btn').on('click', function() {
            $(this).prop('disabled', true);
            $('#stop-refresh-btn').prop('disabled', false);
            buscarUsuario(); // Primera búsqueda inmediata
            intervalId = setInterval(buscarUsuario, 15000); // Luego cada 15 segundos
        });

        $('#stop-refresh-btn').on('click', function() {
            $(this).prop('disabled', true);
            $('#auto-refresh-btn').prop('disabled', false);
            if (intervalId !== null) {
                clearInterval(intervalId);
                intervalId = null;
            }
        });

        // Ya no necesitamos esta función, la hemos integrado directamente en toggleTheme
        
        document.getElementById('add-btn').addEventListener('click', function() {
            const crypto = document.getElementById('crypto_trans').value;
            const fiat = document.getElementById('fiat_trans').value;
            const paymentMethod = document.getElementById('payment-method-trans').value;
            const buyAmount = parseFloat(document.getElementById('buy-amount').value) || 0;
            const sellAmount = parseFloat(document.getElementById('sell-amount').value) || 0;
            const commission = parseFloat(document.getElementById('commission').value) || 0;

            // Ganancia bruta
            const grossProfit = sellAmount - buyAmount;
            // Ganancia neta descontando comisión proporcional
            const netProfit = grossProfit - commission;
            // Porcentaje de comisión sobre la ganancia bruta
            let commissionPct = grossProfit !== 0 ? (commission / grossProfit) * 100 : 0;

            const table = document.getElementById('transaction-table').getElementsByTagName('tbody')[0];
            const newRow = table.insertRow();

            // Verificar si estamos en modo oscuro y aplicar clase si es necesario
            if (document.documentElement.getAttribute('data-theme') === 'dark') {
                newRow.classList.add('dark-row');
            }
            
            newRow.innerHTML = `
                <td contenteditable="false">${crypto}</td>
                <td contenteditable="false">${fiat}</td>
                <td contenteditable="false">${paymentMethod}</td>
                <td contenteditable="false">${buyAmount.toFixed(2)}</td>
                <td contenteditable="false">${sellAmount.toFixed(2)}</td>
                <td contenteditable="false">${commission.toFixed(2)}<br><span class='text-muted' style='font-size:0.8em;'>(${commissionPct.toFixed(2)}%)</span></td>
                <td contenteditable="false">${netProfit.toFixed(2)}</td>
                <td>
                    <button class="edit-btn btn btn-sm btn-warning">Editar</button>
                    <button class="delete-btn btn btn-sm btn-danger">Borrar</button>
                </td>
            `;

            // Generar un id único para el select de método de pago en la fila
            let rowId = Math.floor(Math.random() * 1000000);

            newRow.querySelector('.edit-btn').addEventListener('click', function() {
                const cells = newRow.querySelectorAll('td');
                const isEditable = cells[0].contentEditable === "true";
                const cryptoCell = cells[0];
                const fiatCell = cells[1];
                const paymentMethodCell = cells[2];
                const buyAmountCell = cells[3];
                const sellAmountCell = cells[4];
                const commissionCell = cells[5];
                const profitCell = cells[6];

                if (!isEditable) {
                    // Guardar valores actuales
                    let currentCrypto = cryptoCell.textContent.trim();
                    let currentFiat = fiatCell.textContent.trim();
                    let currentPayment = paymentMethodCell.textContent.trim();
                    let selectId = `payment-method-trans${rowId}`;

                    // Renderizar selects
                    cryptoCell.innerHTML = `<select class='form-select form-select-sm' style='min-width:80px;'>${document.getElementById('crypto_trans').innerHTML}</select>`;
                    fiatCell.innerHTML = `<select class='form-select form-select-sm' style='min-width:80px;'>${document.getElementById('fiat_trans').innerHTML}</select>`;
                    paymentMethodCell.innerHTML = `<select id='${selectId}' class='form-select form-select-sm' style='min-width:100px;'><option>Cargando...</option></select>`;
                    buyAmountCell.innerHTML = `<input type='number' class='form-control form-control-sm' value='${parseFloat(buyAmountCell.textContent).toFixed(2)}' style='width:110px;display:inline-block;' step='any'>`;
                    sellAmountCell.innerHTML = `<input type='number' class='form-control form-control-sm' value='${parseFloat(sellAmountCell.textContent).toFixed(2)}' style='width:110px;display:inline-block;' step='any'>`;
                    let commissionVal = commissionCell.textContent.split("(")[0].trim();
                    commissionCell.innerHTML = `<input type='number' class='form-control form-control-sm' value='${parseFloat(commissionVal).toFixed(2)}' style='width:90px;display:inline-block;' step='any'>`;

                    // Seleccionar valores actuales en los selects
                    setTimeout(() => {
                        let cryptoSelect = cryptoCell.querySelector('select');
                        let fiatSelect = fiatCell.querySelector('select');
                        if (cryptoSelect && currentCrypto) cryptoSelect.value = currentCrypto;
                        if (fiatSelect && currentFiat) fiatSelect.value = currentFiat;
                        // Función para actualizar métodos de pago según cripto y fiat
                        function updateRowPaymentMethods() {
                            let asset = cryptoCell.querySelector('select').value;
                            let fiat = fiatCell.querySelector('select').value;
                            let $payType = $(paymentMethodCell).find('select');
                            $payType.empty();
                            $payType.append('<option>Cargando...</option>');
                            $.ajax({
                                url: '/api/payment_methods',
                                method: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({ asset: asset, fiat: fiat }),
                                success: function(res) {
                                    $payType.empty();
                                    $payType.append('<option value="">Todos</option>');
                                    if (res.payment_methods && res.payment_methods.length > 0) {
                                        res.payment_methods.forEach(method => {
                                            if (typeof method === 'object' && method.name) {
                                                $payType.append(`<option value="${method.id}">${method.name}</option>`);
                                            } else if (typeof method === 'string') {
                                                $payType.append(`<option value="${method}">${method}</option>`);
                                            }
                                        });
                                    } else {
                                        $payType.append('<option value="">No hay métodos disponibles</option>');
                                    }
                                    // Seleccionar el valor actual si existe
                                    if (currentPayment) {
                                        $payType.find('option').each(function() {
                                            if ($(this).text() === currentPayment || $(this).val() === currentPayment) {
                                                $(this).prop('selected', true);
                                            }
                                        });
                                    }
                                },
                                error: function() {
                                    $payType.empty();
                                    $payType.append('<option value="">Error al cargar métodos</option>');
                                }
                            });
                        }
                        // Inicializar métodos de pago
                        updateRowPaymentMethods();
                        // Al cambiar cripto o fiat en la fila, actualizar métodos de pago
                        $(cryptoCell).find('select').on('change', updateRowPaymentMethods);
                        $(fiatCell).find('select').on('change', updateRowPaymentMethods);
                    }, 10);
                } else {
                    cryptoCell.textContent = cryptoCell.querySelector('select').value;
                    fiatCell.textContent = fiatCell.querySelector('select').value;
                    let select = paymentMethodCell.querySelector('select');
                    paymentMethodCell.textContent = select ? select.options[select.selectedIndex].text : '';
                    const buyAmount = parseFloat(buyAmountCell.querySelector('input').value) || 0;
                    const sellAmount = parseFloat(sellAmountCell.querySelector('input').value) || 0;
                    const commission = parseFloat(commissionCell.querySelector('input').value) || 0;
                    buyAmountCell.textContent = buyAmount.toFixed(2);
                    sellAmountCell.textContent = sellAmount.toFixed(2);
                    const grossProfit = sellAmount - buyAmount;
                    const netProfit = grossProfit - commission;
                    let commissionPct = grossProfit !== 0 ? (commission / grossProfit) * 100 : 0;
                    commissionCell.innerHTML = `${commission.toFixed(2)}<br><span class='text-muted' style='font-size:0.8em;'>(${commissionPct.toFixed(2)}%)</span>`;
                    profitCell.textContent = netProfit.toFixed(2);
                }

                cells.forEach(cell => {
                    if (cell !== cells[cells.length - 1]) {
                        cell.contentEditable = !isEditable;
                    }
                });
                this.textContent = isEditable ? 'Editar' : 'Guardar';
            });

            newRow.querySelector('.delete-btn').addEventListener('click', function() {
                table.deleteRow(newRow.rowIndex - 1);
            });
        });

        // --- FORMULARIO DE TRANSACCIONES (ABAJO) ---
        $('#crypto_trans, #fiat_trans').on('change', function() {
            updatePaymentMethodsGeneric('#crypto_trans', '#fiat_trans', '#payment-method-trans');
        });
        // Inicializar al cargar
        $(function() {
            if ($('#crypto_trans').val() && $('#fiat_trans').val()) {
                updatePaymentMethodsGeneric('#crypto_trans', '#fiat_trans', '#payment-method-trans');
            }
        });

        // Corregir el botón Borrar Todo para la tabla de transacciones
        document.getElementById('clear-btn').addEventListener('click', function() {
            const table = document.getElementById('transaction-table').getElementsByTagName('tbody')[0];
            table.innerHTML = '';
        });

        document.getElementById('export-excel-btn').addEventListener('click', function() {
            // Obtener la tabla
            var table = document.getElementById('transaction-table');
            // Clonar la tabla para manipularla sin afectar la original
            var tableClone = table.cloneNode(true);
            // Eliminar la última columna (Acciones) de cada fila
            for (let row of tableClone.rows) {
                if (row.cells.length > 0) {
                    row.deleteCell(-1);
                }
            }
            // Convertir la tabla clonada a una hoja de cálculo
            var wb = XLSX.utils.table_to_book(tableClone, {sheet: "Transacciones"});
            // Exportar el archivo Excel
            XLSX.writeFile(wb, 'transacciones_arbitraje.xlsx');
        });
    });
    </script>
</body>
</html>
